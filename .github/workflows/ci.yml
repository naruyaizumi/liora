name: Code Quality & Security

on:
    push:
        branches: [main]
        paths:
            - "src/**/*.js"
            - "*.js"
            - "package.json"
            - "install.sh"
            - "src/lib/shell/**/*.sh"
    pull_request:
        branches: [main]
        paths:
            - "src/**/*.js"
            - "*.js"
            - "package.json"
            - "install.sh"
            - "src/lib/shell/**/*.sh"

permissions:
    contents: read
    security-events: write
    actions: read
    pull-requests: write

jobs:
    eslint:
        name: ESLint Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies fresh
              run: |
                  bun add -D @eslint/js globals eslint

            - name: Run ESLint
              run: bunx eslint . --config ./.github/eslint.config.js

    dependency-audit:
        name: Dependency Security Audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Run security audit
              run: |
                  bun audit

    shell-scripts:
        name: Shell Script Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Check shellcheck availability
              id: check-shellcheck
              run: |
                  command -v shellcheck && echo "available=true" >> $GITHUB_OUTPUT || echo "available=false" >> $GITHUB_OUTPUT

            - name: Lint installer script
              if: steps.check-shellcheck.outputs.available == 'true'
              run: shellcheck -e SC1091 -e SC2034 install.sh || true

            - name: Lint shell library scripts
              if: steps.check-shellcheck.outputs.available == 'true'
              run: |
                  for script in src/lib/shell/*.sh; do
                    echo "Checking $script..."
                    shellcheck -e SC1091 -e SC2034 "$script" || true
                  done

            - name: Test installer (dry-run)
              run: |
                  bash -n install.sh || exit 1

            - name: Test shell library scripts (dry-run)
              run: |
                  for script in src/lib/shell/*.sh; do
                    echo "Testing $script..."
                    bash -n "$script" || exit 1
                  done

    trivy-scan:
        name: Trivy Security Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Run Trivy vulnerability scanner (Filesystem)
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-fs-results.sarif"
                  severity: "CRITICAL,HIGH,MEDIUM"
                  exit-code: "0"

            - name: Run Trivy vulnerability scanner (Config files)
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "config"
                  scan-ref: "."
                  format: "json"
                  output: "trivy-config-results.json"
                  exit-code: "0"

    codeql:
        name: CodeQL Analysis
        runs-on: ubuntu-latest
        timeout-minutes: 360
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Initialize CodeQL
              uses: github/codeql-action/init@v4
              with:
                  languages: javascript
                  queries: security-extended,security-and-quality
                  config: |
                      paths:
                        - src
                      paths-ignore:
                        - node_modules
                        - "**/*.md"
                        - "**/*.json"
                        - "**/*.yml"
                        - "**/*.yaml"

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v4
              with:
                  category: "/language:javascript"
                  upload: true
                  output: codeql-results

    njsscan:
        name: Njsscan Security Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Install Njsscan
              run: pip install njsscan

            - name: Run Njsscan
              run: njsscan --output . 2>&1 || true

    prettier-write:
        name: Prettier Format
        runs-on: ubuntu-latest
        needs: [eslint, dependency-audit, shell-scripts, trivy-scan, codeql, njsscan]
        if: |
            always() && 
            (needs.eslint.result == 'success' || needs.eslint.result == 'skipped') &&
            (needs.dependency-audit.result == 'success' || needs.dependency-audit.result == 'skipped') &&
            (needs.shell-scripts.result == 'success' || needs.shell-scripts.result == 'skipped') &&
            (needs.trivy-scan.result == 'success' || needs.trivy-scan.result == 'skipped') &&
            (needs.codeql.result == 'success' || needs.codeql.result == 'skipped') &&
            (needs.njsscan.result == 'success' || needs.njsscan.result == 'skipped')
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: Checkout code with PAT token
              uses: actions/checkout@v6
              with:
                  token: ${{ secrets.PAT_TOKEN }}

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install Prettier
              run: bun add -D prettier

            - name: Run Prettier check
              id: prettier-check
              run: |
                  echo "Checking formatting with Prettier..."
                  if bunx prettier --check .; then
                      echo "No formatting issues found"
                      echo "has_changes=false" >> $GITHUB_OUTPUT
                  else
                      echo "Formatting issues detected"
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: Format files with Prettier
              if: steps.prettier-check.outputs.has_changes == 'true'
              run: |
                  echo "Formatting all files with Prettier..."
                  bunx prettier --write .

            - name: Configure git user
              if: steps.prettier-check.outputs.has_changes == 'true'
              run: |
                  git config user.name "liora-bot"
                  git config user.email "liora.bot.official@gmail.com"

            - name: Commit and push changes
              if: steps.prettier-check.outputs.has_changes == 'true'
              run: |
                  git add .

                  if git diff --cached --quiet; then
                      echo "No changes to commit"
                      exit 0
                  fi

                  git commit -m "style: format code with Prettier"

                  git push https://liora-bot:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
