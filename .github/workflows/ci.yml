name: CI/CD & Release

on:
    push:
        branches: ["main"]
        paths-ignore:
            - "**.md"
            - "docs/**"
            - ".gitignore"
    pull_request:
        branches: ["main"]
        paths-ignore:
            - "**.md"
            - "docs/**"
            - ".gitignore"

permissions:
    contents: write
    security-events: write
    actions: read
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
# ============================================
# JavaScript/TypeScript Quality Checks
# ============================================
    javascript-quality:
        name: JavaScript Quality & Security
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install native dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    ffmpeg \
                    libwebp-dev \
                    libavformat-dev \
                    libavcodec-dev \
                    libavutil-dev \
                    libswresample-dev \
                    libswscale-dev \
                    libavfilter-dev \
                    build-essential \
                    python3 \
                    g++ \
                    pkg-config \
                    cmake

            - name: Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '.github/workflows/*.yml') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install Dependencies
              run: bun install --frozen-lockfile

            - name: Check Prettier formatting
              run: bun run format:check
              continue-on-error: true

            - name: Run ESLint
              run: bun run lint

            - name: Check for outdated dependencies
              run: |
                  echo "üì¶ Checking for outdated packages..."
                  bun outdated || echo "‚ö†Ô∏è Some packages are outdated"

            - name: List all dependencies
              run: |
                  echo "üìã Listing all dependencies..."
                  bun pm ls --all || echo "‚ö†Ô∏è Could not list all dependencies"

# ============================================
# Rust Quality Checks
# ============================================
    rust-quality:
        name: Rust Quality & Security
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Cache Cargo
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      lib/rs/target/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock', '.github/workflows/*.yml') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Check Rust formatting
              working-directory: ./lib/rs
              run: cargo fmt --all -- --check
              continue-on-error: true

            - name: Run Clippy
              working-directory: ./lib/rs
              run: cargo clippy --all-targets --all-features -- -D warnings

            - name: Install cargo-audit
              run: cargo install cargo-audit --locked

            - name: Rust Security Audit
              working-directory: ./lib/rs
              continue-on-error: true
              run: cargo audit

            - name: Check Rust build
              working-directory: ./lib/rs
              run: cargo check --release --verbose

            - name: Run Rust tests
              working-directory: ./lib/rs
              run: cargo test --release --verbose

# ============================================
# C++ Quality Checks
# ============================================
    cpp-quality:
        name: C++ Quality Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install clang-format
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang-format

            - name: Check C++ formatting
              run: |
                  echo "üîç Checking C++ code formatting..."
                  FORMAT_ISSUES=0
                  
                  CPP_FILES=$(find lib/cpp -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.cc" \) 2>/dev/null)
                  
                  if [ -z "$CPP_FILES" ]; then
                    echo "üç• No C++ files found to check"
                    exit 0
                  fi
                  
                  while IFS= read -r file; do
                  if clang-format --dry-run --Werror "$file" 2>/dev/null; then
                  echo "‚ö° $file is properly formatted"
                  else
                  echo "‚ò†Ô∏è $file needs formatting"
                  FORMAT_ISSUES=1
                  fi
                  done <<< "$CPP_FILES"
                  
                  if [ $FORMAT_ISSUES -eq 1 ]; then
                  echo ""
                  echo "‚ö†Ô∏è C++ formatting issues found. They will be auto-fixed in the next step."
                  else
                  echo "‚ö° All C++ files are properly formatted"
                  fi
              continue-on-error: true

            - name: Auto-format C++ code
              run: |
                  echo "‚ú® Auto-formatting C++ files..."
                  find lib/cpp -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.cc" \) -exec clang-format -i {} \;
                  echo "‚ö° C++ files formatted"

# ============================================
# CodeQL Security Analysis
# ============================================
    codeql-analysis:
        name: CodeQL Security Analysis
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                language: ['javascript', 'rust', 'cpp']
        
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Initialize CodeQL
              uses: github/codeql-action/init@v3
              with:
                  languages: ${{ matrix.language }}
                  queries: security-extended,security-and-quality

            - name: Autobuild
              uses: github/codeql-action/autobuild@v3

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v3
              with:
                  category: "/language:${{matrix.language}}"

# ============================================
# Build & Integration Tests
# ============================================
    integration-build:
        name: Integration Build Test
        needs: [javascript-quality, rust-quality, cpp-quality]
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install all dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    ffmpeg \
                    libwebp-dev \
                    libavformat-dev \
                    libavcodec-dev \
                    libavutil-dev \
                    libswresample-dev \
                    libswscale-dev \
                    libavfilter-dev \
                    build-essential \
                    python3 \
                    g++ \
                    pkg-config \
                    cmake

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun/install/cache
                      ~/.cargo/bin/
                      ~/.cargo/registry/
                      lib/rs/target/
                  key: ${{ runner.os }}-integration-${{ hashFiles('**/bun.lockb', '**/Cargo.lock', '.github/workflows/*.yml') }}

            - name: Install Bun dependencies
              run: bun install --frozen-lockfile

            - name: Build Rust components
              working-directory: ./lib/rs
              run: cargo build --release --verbose

            - name: Verify build artifacts
              run: |
                  echo "üîç Verifying build artifacts..."
                  
                  if ls lib/rs/target/release/*.so 2>/dev/null || \
                     ls lib/rs/target/release/*.dylib 2>/dev/null || \
                     ls lib/rs/target/release/*.dll 2>/dev/null || \
                     ls lib/rs/target/release/lib*.a 2>/dev/null; then
                    echo "‚ö° Rust library artifacts found:"
                    ls -lh lib/rs/target/release/*.{so,dylib,dll,a} 2>/dev/null || true
                  else
                    echo "üç• No Rust library artifacts found (may be expected)"
                  fi
                  
                  if [ -d "lib/rs/target/release" ]; then
                    BINARIES=$(find lib/rs/target/release -maxdepth 1 -type f -executable)
                    if [ -n "$BINARIES" ]; then
                      echo "‚ö° Rust binaries found:"
                      echo "$BINARIES" | while read -r bin; do
                        ls -lh "$bin"
                      done
                    fi
                  fi
                  
                  echo "‚ö° Build verification complete"

# ============================================
# Dependency Review (PRs only)
# ============================================
    dependency-review:
        name: Dependency Review
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Dependency Review
              uses: actions/dependency-review-action@v4
              with:
                  fail-on-severity: moderate
                  deny-licenses: GPL-2.0, GPL-3.0

# ============================================
# Auto-format & Release Pipeline
# ============================================
    release-pipeline:
        name: Format & Auto Release
        needs: [javascript-quality, rust-quality, cpp-quality, codeql-analysis, integration-build]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.PAT_TOKEN }}
                  fetch-depth: 0

            - name: Check version change
              id: check_version
              run: |
                  if git show HEAD^:package.json 2>/dev/null; then
                    PREV_VERSION=$(git show HEAD^:package.json | jq -r '.version')
                  else
                    PREV_VERSION="0.0.0"
                  fi
                  NEW_VERSION=$(jq -r '.version' package.json)

                  echo "Previous version: $PREV_VERSION"
                  echo "Current version: $NEW_VERSION"

                  if [ "$PREV_VERSION" != "$NEW_VERSION" ]; then
                    echo "version_changed=true" >> $GITHUB_OUTPUT
                    echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                    
                    PREV_MAJOR=$(echo $PREV_VERSION | cut -d. -f1)
                    NEW_MAJOR=$(echo $NEW_VERSION | cut -d. -f1)
                    
                    if [ "$NEW_MAJOR" -gt "$PREV_MAJOR" ]; then
                      echo "is_major=true" >> $GITHUB_OUTPUT
                    else
                      echo "is_major=false" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "version_changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Setup Bun
              if: steps.check_version.outputs.version_changed == 'true'
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Rust
              if: steps.check_version.outputs.version_changed == 'true'
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt

            - name: Install dependencies
              if: steps.check_version.outputs.version_changed == 'true'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang-format

            - name: Auto-format all code
              if: steps.check_version.outputs.version_changed == 'true'
              run: |
                  set -e
                  
                  echo "üì¶ Installing dependencies..."
                  bun install --frozen-lockfile
                  
                  echo "‚ú® Formatting JavaScript/TypeScript..."
                  bunx prettier --write .
                  
                  echo "‚ú® Formatting Rust code..."
                  if [ -d "lib/rs" ]; then
                    cd lib/rs
                    cargo fmt --all
                    cd ../..
                  fi
                  
                  echo "‚ú® Formatting C++ code..."
                  if [ -d "lib/cpp" ]; then
                    find lib/cpp -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.cc" \) -exec clang-format -i {} \;
                  fi
                  
                  echo "‚ö° All formatting complete"

            - name: Commit formatting changes
              if: steps.check_version.outputs.version_changed == 'true'
              run: |
                  git config --global user.name "naruyaizumi"
                  git config --global user.email "sexystyle088@gmail.com"

                  if [[ `git status --porcelain` ]]; then
                    echo "üìù Formatting changes detected, committing..."
                    
                    git pull --rebase origin main || {
                      echo "‚ö†Ô∏è Rebase conflict detected, aborting..."
                      git rebase --abort
                      exit 1
                    }
                    
                    git add .
                    git commit -m "style: auto-format with Prettier, cargo fmt, and clang-format [skip ci]"
                    
                    for i in {1..3}; do
                      if git push origin main; then
                        echo "‚ö° Formatting changes committed and pushed"
                        break
                      else
                        if [ $i -eq 3 ]; then
                          echo "‚ò†Ô∏è Failed to push after 3 attempts"
                          exit 1
                        fi
                        echo "‚ö†Ô∏è Push failed, retrying... (attempt $i/3)"
                        git pull --rebase origin main
                        sleep 2
                      fi
                    done
                    
                    echo "‚è≥ Waiting for GitHub to process changes..."
                    sleep 5
                  else
                    echo "‚ö° No formatting changes needed"
                  fi

            - name: Check if release needed
              id: check_release
              if: steps.check_version.outputs.version_changed == 'true'
              run: |
                  NEW_VERSION="${{ steps.check_version.outputs.new_version }}"
                  
                  if git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; then
                    echo "do_release=false" >> $GITHUB_OUTPUT
                    echo "üç• Tag v${NEW_VERSION} already exists"
                  else
                    echo "do_release=true" >> $GITHUB_OUTPUT
                    echo "release_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "‚ö° Release v${NEW_VERSION} will be created"
                  fi

            - name: Generate changelog from commits
              id: changelog
              if: steps.check_release.outputs.do_release == 'true'
              run: |
                  VERSION="${{ steps.check_release.outputs.release_version }}"
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  
                  if [ -n "$LAST_TAG" ]; then
                    echo "üìù Generating changelog from $LAST_TAG to HEAD"
                    COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
                  else
                    echo "üìù Generating changelog for first release"
                    COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
                  fi

                  {
                    echo "## üöÄ What's Changed in v${VERSION}"
                    echo ""
                    if [ -n "$COMMITS" ]; then
                      echo "$COMMITS"
                    else
                      echo "- Initial release"
                    fi
                    echo ""
                    if [ -n "$LAST_TAG" ]; then
                      echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${VERSION}"
                    else
                      echo "**Full Changelog**: https://github.com/${{ github.repository }}/commits/v${VERSION}"
                    fi
                  } > /tmp/changelog.md
                  
                  echo "‚ö° Changelog generated"
                  cat /tmp/changelog.md

            - name: Create GitHub Release
              if: steps.check_release.outputs.do_release == 'true'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.check_release.outputs.release_version }}
                  name: "Release v${{ steps.check_release.outputs.release_version }}"
                  body_path: /tmp/changelog.md
                  draft: false
                  prerelease: ${{ steps.check_version.outputs.is_major == 'true' }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Notify release
              if: steps.check_release.outputs.do_release == 'true'
              run: |
                  VERSION="${{ steps.check_release.outputs.release_version }}"
                  IS_MAJOR="${{ steps.check_version.outputs.is_major }}"
                  
                  if [ "$IS_MAJOR" == "true" ]; then
                    echo "üéâ Major release v${VERSION} created! This includes breaking changes."
                  else
                    echo "‚ö° Release v${VERSION} created successfully!"
                  fi
                  
                  echo "üì¶ Release URL: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"