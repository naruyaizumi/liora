name: Dependency Update Check

on:
    schedule:
        - cron: "0 0 * * 0"
    workflow_dispatch:

permissions:
    contents: write
    pull-requests: write

jobs:
    check-updates:
        name: Check for Dependency Updates
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.PAT_TOKEN }}

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Check for outdated packages
              id: outdated
              run: |
                  echo "ğŸ“¦ Checking for outdated packages..."
                  bun outdated > outdated.txt 2>&1 || true
                  
                  if [ -s outdated.txt ]; then
                    echo "has_updates=true" >> $GITHUB_OUTPUT
                    cat outdated.txt
                  else
                    echo "has_updates=false" >> $GITHUB_OUTPUT
                    echo "All packages are up to date!"
                  fi

            - name: Create update report
              if: steps.outdated.outputs.has_updates == 'true'
              run: |
                  cat > update-report.md << 'EOF'
                  ## ğŸ“¦ Weekly Dependency Update Report
                  
                  The following dependencies have updates available:
                  
                  ```
                  EOF
                  cat outdated.txt >> update-report.md
                  cat >> update-report.md << 'EOF'
                  ```
                  
                  ### Action Required
                  
                  Please review these updates and:
                  1. Check changelog for breaking changes
                  2. Test updates in development environment
                  3. Update dependencies manually with `bun update`
                  4. Run tests to ensure compatibility
                  
                  ### Auto-Update Command
                  
                  To update all non-breaking changes:
                  ```bash
                  bun update
                  ```
                  
                  **Note:** Major version updates should be reviewed carefully.
                  EOF

            - name: Create pull request
              if: steps.outdated.outputs.has_updates == 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.PAT_TOKEN }}
                  commit-message: "chore(deps): dependency update report"
                  branch: chore/dependency-updates
                  title: "ğŸ“¦ Weekly Dependency Update Report"
                  body-path: update-report.md
                  labels: dependencies, automated
