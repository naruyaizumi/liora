name: Monitoring & Reporting

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  issues: write

jobs:
  collect-metrics:
    name: Collect Repository Metrics
    runs-on: ubuntu-latest
    outputs:
      metrics: ${{ steps.collect.outputs.metrics }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Collect metrics
        id: collect
        run: |
          TOTAL_FILES=$(find src lib -type f \( -name "*.js" -o -name "*.rs" -o -name "*.cpp" \) | wc -l)
          TOTAL_LINES=$(find src lib -type f \( -name "*.js" -o -name "*.rs" -o -name "*.cpp" \) -exec wc -l {} + | tail -1 | awk '{print $1}')
          
          TOTAL_COMMITS=$(git rev-list --count HEAD)
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          
          COMMITS_LAST_WEEK=$(git log --since='7 days ago' --oneline | wc -l)
          
          echo "metrics<<EOF" >> $GITHUB_OUTPUT
          echo "{" >> $GITHUB_OUTPUT
          echo "  \"total_files\": $TOTAL_FILES," >> $GITHUB_OUTPUT
          echo "  \"total_lines\": $TOTAL_LINES," >> $GITHUB_OUTPUT
          echo "  \"total_commits\": $TOTAL_COMMITS," >> $GITHUB_OUTPUT
          echo "  \"contributors\": $CONTRIBUTORS," >> $GITHUB_OUTPUT
          echo "  \"commits_last_week\": $COMMITS_LAST_WEEK" >> $GITHUB_OUTPUT
          echo "}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  generate-report:
    name: Generate HTML Report
    runs-on: ubuntu-latest
    needs: collect-metrics
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Get workflow runs
        id: workflows
        uses: actions/github-script@v8
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const success = runs.data.workflow_runs.filter(r => r.conclusion === 'success').length;
            const failed = runs.data.workflow_runs.filter(r => r.conclusion === 'failure').length;
            const total = runs.data.workflow_runs.length;
            
            return { success, failed, total, rate: ((success/total)*100).toFixed(1) };

      - name: Upload dashboard
        uses: actions/upload-artifact@v6
        with:
          name: dashboard
          path: reports/

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.PAT_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
          destination_dir: dashboard

  weekly-report:
    name: Generate Weekly Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate report
        run: |
          # Weekly statistics
          COMMITS_WEEK=$(git log --since='7 days ago' --oneline | wc -l)
          CONTRIBUTORS_WEEK=$(git log --since='7 days ago' --format='%aN' | sort -u | wc -l)
          
          cat > weekly-report.md << EOF
          # ðŸ“Š Weekly Report
          
          ## Activity Summary (Last 7 Days)
          
          - **Commits**: $COMMITS_WEEK
          - **Contributors**: $CONTRIBUTORS_WEEK
          - **Date**: $(date +"%Y-%m-%d")
          
          ## Top Contributors
          $(git log --since='7 days ago' --format='%aN' | sort | uniq -c | sort -rn | head -5)
          
          ---
          *Generated automatically by GitHub Actions*
          EOF

      - name: Create issue with report
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('weekly-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Weekly Report - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['report', 'automated']
            });