name: Weekly Security Audit

on:
    schedule:
        - cron: "0 0 * * 1"
    workflow_dispatch: # Allow manual trigger

permissions:
    contents: read
    security-events: write
    issues: write

jobs:
    security-audit:
        name: Comprehensive Security Audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: List JavaScript dependencies
              id: js_deps
              continue-on-error: true
              run: |
                  echo "ðŸ“‹ Listing JavaScript dependencies..."
                  bun pm ls --all > js-deps.txt || true
                  
                  if [ -f js-deps.txt ]; then
                    DEPS_COUNT=$(wc -l < js-deps.txt)
                    echo "Found $DEPS_COUNT dependencies"
                    echo "dependencies=$DEPS_COUNT" >> $GITHUB_OUTPUT
                  fi

            - name: Check outdated packages
              id: outdated
              continue-on-error: true
              run: |
                  echo "ðŸ“¦ Checking for outdated packages..."
                  bun outdated > outdated-packages.txt || true
                  
                  if [ -f outdated-packages.txt ]; then
                    OUTDATED_COUNT=$(wc -l < outdated-packages.txt)
                    echo "Found $OUTDATED_COUNT outdated packages"
                    echo "outdated=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
                  fi

            - name: Install cargo-audit
              run: cargo install cargo-audit --locked

            - name: Rust Security Audit
              id: rust_audit
              continue-on-error: true
              working-directory: ./lib/rs
              run: |
                  echo "ðŸ” Running Rust security audit..."
                  cargo audit --json > ../../rust-audit.json || true
                  
                  if [ -f ../../rust-audit.json ]; then
                    VULNERABILITIES=$(cat ../../rust-audit.json | jq -r '.vulnerabilities.count // 0')
                    echo "Found $VULNERABILITIES vulnerabilities"
                    echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
                  fi

            - name: Upload audit results
              uses: actions/upload-artifact@v4
              with:
                  name: security-audit-results
                  path: |
                      js-deps.txt
                      outdated-packages.txt
                      rust-audit.json

            - name: Create security report
              run: |
                  cat > security-report.md << 'EOF'
                  ## ðŸ” Weekly Security Audit Report
                  
                  **Date:** $(date +%Y-%m-%d)
                  
                  ### JavaScript Dependencies
                  - Total dependencies: ${{ steps.js_deps.outputs.dependencies || 'N/A' }}
                  - Outdated packages: ${{ steps.outdated.outputs.outdated || 'N/A' }}
                  
                  ### Rust Dependencies
                  - Vulnerabilities found: ${{ steps.rust_audit.outputs.vulnerabilities || 0 }}
                  
                  ### Recommendations
                  1. Review outdated packages and update when possible
                  2. Check vulnerability reports for severity levels
                  3. Update dependencies with known security issues
                  
                  **Artifacts:** Check the workflow run for detailed reports.
                  EOF

            - name: Create issue if critical issues found
              if: steps.rust_audit.outputs.vulnerabilities > 0
              uses: actions/github-script@v7
              with:
                  script: |
                      const rustVulns = ${{ steps.rust_audit.outputs.vulnerabilities || 0 }};
                      
                      if (rustVulns > 0) {
                        await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: 'ðŸ” Security Alert: Vulnerabilities Detected',
                          body: `## Security Audit Alert
                      
                      **Rust Dependencies:** ${rustVulns} vulnerabilities found
                      
                      Please review the [audit report](${context.payload.repository.html_url}/actions/runs/${context.runId}) and update vulnerable dependencies immediately.
                      
                      **Priority:** ${rustVulns > 5 ? 'ðŸ”´ High' : 'ðŸŸ¡ Medium'}`,
                          labels: ['security', 'dependencies', 'high-priority']
                        });
                      }
