name: Deployment

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - production
          - staging
          - development

permissions:
  contents: read
  id-token: write

jobs:
  test-installation:
    name: Test Installation on ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: Ubuntu 24.04
            runner: ubuntu-24.04
          - os: Debian 12
            runner: ubuntu-latest
            container: debian:12-slim
    steps:
      - name: Test curl installation on ${{ matrix.os }}
        run: |
          if [ "${{ matrix.os }}" = "Debian 12" ]; then
            apt-get update && apt-get install -y curl
          fi
          echo "Testing installation on ${{ matrix.os }}..."
          curl -sSL https://raw.githubusercontent.com/naruyaizumi/liora/main/service.sh | bash -s -- --dry-run
          echo "Installation test passed on ${{ matrix.os }}"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test-installation]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "# Installation Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- Installation Tests: ${{ needs.test-installation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tested Platforms" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu 24.04: " >> $GITHUB_STEP_SUMMARY
          echo "- Debian 12: " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment || 'test' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tested at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Installation Test Failed',
              body: `Installation test failed on ${{ github.event.inputs.environment || 'test' }}.\n\n**Details:**\n- Installation Tests: ${{ needs.test-installation.result }}\n\nWorkflow: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['deployment', 'test-failure', 'bug']
            });