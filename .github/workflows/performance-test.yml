name: Performance Test

on:
    push:
        branches: ["main"]
        paths-ignore:
            - "**.md"
            - "docs/**"
    pull_request:
        branches: ["main"]
        paths-ignore:
            - "**.md"
            - "docs/**"

jobs:
    benchmark:
        name: Performance Benchmarks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    ffmpeg \
                    libwebp-dev \
                    libavformat-dev \
                    libavcodec-dev \
                    libavutil-dev \
                    libswresample-dev \
                    libswscale-dev \
                    libavfilter-dev \
                    build-essential \
                    python3 \
                    g++ \
                    pkg-config \
                    cmake

            - name: Install Bun dependencies
              run: bun install --frozen-lockfile

            - name: Cache Cargo
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      lib/rs/target/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock', '.github/workflows/*.yml') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Run Rust benchmarks
              working-directory: ./lib/rs
              run: |
                  # Build benchmarks first
                  cargo bench --no-run
                  
                  # Run benchmarks and save results
                  echo "üöÄ Running performance benchmarks..."
                  cargo bench 2>&1 | tee ../../bench-results.txt
                  
                  # Check if benchmarks ran successfully
                  if [ ${PIPESTATUS[0]} -eq 0 ]; then
                    echo "üî• Benchmarks completed successfully"
                  else
                    echo "‚ö†Ô∏è Benchmarks had issues, but continuing..."
                  fi

            - name: Upload benchmark results
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results
                  path: bench-results.txt
                  retention-days: 7

            - name: Comment PR with results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      try {
                          const results = fs.readFileSync('bench-results.txt', 'utf8');
                          const shortResults = results.split('\n').slice(-50).join('\n'); // Ambil 50 baris terakhir
                          
                          await github.rest.issues.createComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: context.issue.number,
                            body: `## üìä Performance Benchmark Results\n\n\`\`\`\n${shortResults}\n\`\`\`\n\n[View full results](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`
                          });
                      } catch (error) {
                          console.log('Could not read benchmark results:', error.message);
                      }