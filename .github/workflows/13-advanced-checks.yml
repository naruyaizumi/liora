name: Advanced Quality Checks

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install complexity tools
        run: |
          npm install -g complexity-report
          npm install -g jscpd

      - name: Run complexity analysis
        run: |
          cr src lib --format json > complexity.json || true
          
          # Check for high complexity
          node << 'EOF'
          const fs = require('fs');
          try {
            const data = JSON.parse(fs.readFileSync('complexity.json', 'utf8'));
            let hasIssues = false;
            
            data.reports.forEach(report => {
              if (report.aggregate.cyclomatic > 10) {
                console.log(`High complexity in ${report.path}: ${report.aggregate.cyclomatic}`);
                hasIssues = true;
              }
            });
            
            if (hasIssues) {
              console.log('\nConsider refactoring high complexity functions');
            }
          } catch (e) {
            console.log('No complexity issues found');
          }
          EOF

      - name: Detect code duplication
        run: |
          jscpd src lib --format "json" --output "./jscpd-report.json" || true

      - name: Upload reports
        uses: actions/upload-artifact@v6
        with:
          name: code-quality-reports
          path: |
            complexity.json
            jscpd-report.json

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libwebp-dev \
            libavformat-dev \
            libavcodec-dev \
            libavutil-dev \
            libswresample-dev \
            libswscale-dev \
            libavfilter-dev \
            build-essential \
            python3 \
            g++ \
            pkg-config \
            cmake
            
      - name: Install dependencies
        run: bun install

      - name: Check licenses
        run: |
          npx license-checker --summary --production

      - name: Generate license report
        run: |
          npx license-checker --json --out licenses.json
          
          node << 'EOF'
          const fs = require('fs');
          const licenses = JSON.parse(fs.readFileSync('licenses.json', 'utf8'));
          
          let report = '# License Report\n\n';
          report += '| Package | License | Repository |\n';
          report += '|---------|---------|------------|\n';
          
          Object.entries(licenses).forEach(([pkg, info]) => {
            const repo = info.repository || 'N/A';
            report += `| ${pkg} | ${info.licenses} | ${repo} |\n`;
          });
          
          fs.writeFileSync('LICENSE_REPORT.md', report);
          console.log('License report generated');
          EOF

      - name: Upload license report
        uses: actions/upload-artifact@v6
        with:
          name: license-report
          path: LICENSE_REPORT.md

  api-compatibility-check:
    name: API Compatibility Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          path: pr

      - name: Check API changes
        run: |
          grep -r "export " base/lib/api/*.js | grep "function" > base_api.txt || true
          
          grep -r "export " pr/lib/api/*.js | grep "function" > pr_api.txt || true
          
          if ! diff base_api.txt pr_api.txt > api_diff.txt; then
            echo "API changes detected:"
            cat api_diff.txt
            
            if grep "^<" api_diff.txt; then
              echo "BREAKING CHANGE: Functions removed from API"
              echo "breaking_change=true" >> $GITHUB_ENV
            fi
          fi

      - name: Comment on PR if breaking
        if: env.breaking_change == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**WARNING: BREAKING API CHANGES DETECTED**\n\nThis PR removes exported functions from the API. Please ensure this is intentional and update the version accordingly (major bump).'
            })

  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libwebp-dev \
            libavformat-dev \
            libavcodec-dev \
            libavutil-dev \
            libswresample-dev \
            libswscale-dev \
            libavfilter-dev \
            build-essential \
            python3 \
            g++ \
            pkg-config \
            cmake
          bun install

      - name: Run performance tests
        run: |
          bun << 'EOF'
          const start = performance.now();
          
          for (let i = 0; i < 1000000; i++) {
            Math.sqrt(i);
          }
          
          const end = performance.now();
          console.log(`Benchmark completed in ${(end - start).toFixed(2)}ms`);
          EOF

  bundle-size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check bundle size
        run: |
          find src lib -name "*.js" -exec du -h {} \; > sizes.txt
          
          TOTAL=$(find src lib -name "*.js" -exec du -b {} + | awk '{sum+=$1} END {print sum}')
          TOTAL_KB=$(echo "scale=2; $TOTAL / 1024" | bc)
          
          echo "Total JS size: ${TOTAL_KB} KB"
          
          # Check if size is reasonable (< 5MB)
          if [ $(echo "$TOTAL_KB > 5120" | bc) -eq 1 ]; then
            echo "Warning: Bundle size is large (${TOTAL_KB} KB)"
          fi

  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check code accessibility
        run: |
          grep -r "throw new Error" src lib | wc -l > error_count.txt
          
          CONSOLE_LOGS=$(grep -r "console.log" src --exclude-dir=node_modules | wc -l)
          
          if [ $CONSOLE_LOGS -gt 0 ]; then
            echo "Found $CONSOLE_LOGS console.log statements in src/"
            echo "Consider using proper logging library (pino)"
          fi

  type-coverage:
    name: Type Coverage Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check JSDoc coverage
        run: |
          TOTAL_FUNCS=$(grep -r "function\|=>" src lib --include="*.js" | wc -l)
          
          DOC_FUNCS=$(grep -rB1 "\/\*\*" src lib --include="*.js" | grep "function\|=>" | wc -l)
          
          if [ $TOTAL_FUNCS -gt 0 ]; then
            COVERAGE=$(echo "scale=2; ($DOC_FUNCS * 100) / $TOTAL_FUNCS" | bc)
            echo "Documentation coverage: ${COVERAGE}%"
            
            if [ $(echo "$COVERAGE < 50" | bc) -eq 1 ]; then
              echo "Low documentation coverage"
            fi
          fi

  git-history-check:
    name: Git History Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          git log --format=%s origin/main..HEAD > commits.txt
          
          while IFS= read -r msg; do
            if ! echo "$msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"; then
              echo "Non-conventional commit: $msg"
            fi
          done < commits.txt

      - name: Check for large commits
        run: |
          git log --format=%H origin/main..HEAD | while read hash; do
            FILES=$(git show --name-only --format="" $hash | wc -l)
            if [ $FILES -gt 50 ]; then
              echo "Large commit detected: $hash changes $FILES files"
              echo "Consider splitting into smaller commits"
            fi
          done