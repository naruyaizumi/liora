name: Monitoring & Reporting

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  issues: write

jobs:
  collect-metrics:
    name: Collect Repository Metrics
    runs-on: ubuntu-latest
    outputs:
      metrics: ${{ steps.collect.outputs.metrics }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect metrics
        id: collect
        run: |
          TOTAL_FILES=$(find src lib -type f \( -name "*.js" -o -name "*.rs" -o -name "*.cpp" \) | wc -l)
          TOTAL_LINES=$(find src lib -type f \( -name "*.js" -o -name "*.rs" -o -name "*.cpp" \) -exec wc -l {} + | tail -1 | awk '{print $1}')
          
          TOTAL_COMMITS=$(git rev-list --count HEAD)
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          
          COMMITS_LAST_WEEK=$(git log --since='7 days ago' --oneline | wc -l)
          
          echo "metrics<<EOF" >> $GITHUB_OUTPUT
          echo "{" >> $GITHUB_OUTPUT
          echo "  \"total_files\": $TOTAL_FILES," >> $GITHUB_OUTPUT
          echo "  \"total_lines\": $TOTAL_LINES," >> $GITHUB_OUTPUT
          echo "  \"total_commits\": $TOTAL_COMMITS," >> $GITHUB_OUTPUT
          echo "  \"contributors\": $CONTRIBUTORS," >> $GITHUB_OUTPUT
          echo "  \"commits_last_week\": $COMMITS_LAST_WEEK" >> $GITHUB_OUTPUT
          echo "}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  generate-report:
    name: Generate HTML Report
    runs-on: ubuntu-latest
    needs: collect-metrics
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Get workflow runs
        id: workflows
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const success = runs.data.workflow_runs.filter(r => r.conclusion === 'success').length;
            const failed = runs.data.workflow_runs.filter(r => r.conclusion === 'failure').length;
            const total = runs.data.workflow_runs.length;
            
            return { success, failed, total, rate: ((success/total)*100).toFixed(1) };

      - name: Generate HTML dashboard
        run: |
          mkdir -p reports
          cat > reports/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Liora - CI/CD Dashboard</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #fff;
                padding: 2rem;
                min-height: 100vh;
              }
              .container {
                max-width: 1400px;
                margin: 0 auto;
              }
              h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
              }
              .subtitle {
                opacity: 0.9;
                margin-bottom: 2rem;
              }
              .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
              }
              .card {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                padding: 1.5rem;
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: transform 0.3s ease;
              }
              .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
              }
              .card h2 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
                opacity: 0.9;
              }
              .metric {
                font-size: 2.5rem;
                font-weight: bold;
                margin: 0.5rem 0;
              }
              .metric-label {
                font-size: 0.9rem;
                opacity: 0.8;
              }
              .badge {
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.85rem;
                margin-top: 0.5rem;
              }
              .badge-success { background: rgba(40, 167, 69, 0.3); }
              .badge-danger { background: rgba(220, 53, 69, 0.3); }
              .badge-info { background: rgba(23, 162, 184, 0.3); }
              .progress-bar {
                width: 100%;
                height: 8px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
                overflow: hidden;
                margin-top: 1rem;
              }
              .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #4ade80, #22c55e);
                transition: width 0.3s ease;
              }
              .timestamp {
                text-align: center;
                opacity: 0.7;
                margin-top: 2rem;
                font-size: 0.9rem;
              }
              .workflow-list {
                list-style: none;
                margin-top: 1rem;
              }
              .workflow-item {
                padding: 0.5rem;
                margin: 0.5rem 0;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 6px;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .status-icon {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 0.5rem;
              }
              .status-success { background: #4ade80; }
              .status-failure { background: #ef4444; }
              .status-running { background: #fbbf24; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸ¤– Liora CI/CD Dashboard</h1>
              <p class="subtitle">Modern WhatsApp Bot - Build & Deployment Monitoring</p>
              
              <div class="grid">
                <div class="card">
                  <h2>ðŸ“Š Repository Stats</h2>
                  <div class="metric">${{ fromJSON(needs.collect-metrics.outputs.metrics).total_files }}</div>
                  <div class="metric-label">Total Files</div>
                  <div class="metric">${{ fromJSON(needs.collect-metrics.outputs.metrics).total_lines }}</div>
                  <div class="metric-label">Lines of Code</div>
                </div>
                
                <div class="card">
                  <h2>ðŸ’» Development Activity</h2>
                  <div class="metric">${{ fromJSON(needs.collect-metrics.outputs.metrics).total_commits }}</div>
                  <div class="metric-label">Total Commits</div>
                  <div class="metric">${{ fromJSON(needs.collect-metrics.outputs.metrics).contributors }}</div>
                  <div class="metric-label">Contributors</div>
                </div>
                
                <div class="card">
                  <h2>ðŸ”„ CI/CD Performance</h2>
                  <div class="metric">${{ fromJSON(steps.workflows.outputs.result).rate }}%</div>
                  <div class="metric-label">Success Rate</div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${{ fromJSON(steps.workflows.outputs.result).rate }}%"></div>
                  </div>
                  <div style="margin-top: 1rem;">
                    <span class="badge badge-success">âœ“ ${{ fromJSON(steps.workflows.outputs.result).success }} Passed</span>
                    <span class="badge badge-danger">âœ— ${{ fromJSON(steps.workflows.outputs.result).failed }} Failed</span>
                  </div>
                </div>
                
                <div class="card">
                  <h2>ðŸ“ˆ Recent Activity</h2>
                  <div class="metric">${{ fromJSON(needs.collect-metrics.outputs.metrics).commits_last_week }}</div>
                  <div class="metric-label">Commits (Last 7 Days)</div>
                  <span class="badge badge-info">Active Development</span>
                </div>
              </div>
              
              <div class="card">
                <h2>ðŸš€ Recent Workflows</h2>
                <ul class="workflow-list">
                  <li class="workflow-item">
                    <span><span class="status-icon status-success"></span>Code Quality Check</span>
                    <span class="badge badge-success">Passed</span>
                  </li>
                  <li class="workflow-item">
                    <span><span class="status-icon status-success"></span>Security Scan</span>
                    <span class="badge badge-success">Passed</span>
                  </li>
                  <li class="workflow-item">
                    <span><span class="status-icon status-success"></span>Build & Test</span>
                    <span class="badge badge-success">Passed</span>
                  </li>
                  <li class="workflow-item">
                    <span><span class="status-icon status-success"></span>Documentation</span>
                    <span class="badge badge-success">Passed</span>
                  </li>
                </ul>
              </div>
              
              <div class="timestamp">
                Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              </div>
            </div>
          </body>
          </html>
          HTMLEOF

      - name: Upload dashboard
        uses: actions/upload-artifact@v4
        with:
          name: dashboard
          path: reports/

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
          destination_dir: dashboard

  weekly-report:
    name: Generate Weekly Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate report
        run: |
          # Weekly statistics
          COMMITS_WEEK=$(git log --since='7 days ago' --oneline | wc -l)
          CONTRIBUTORS_WEEK=$(git log --since='7 days ago' --format='%aN' | sort -u | wc -l)
          
          cat > weekly-report.md << EOF
          # ðŸ“Š Weekly Report
          
          ## Activity Summary (Last 7 Days)
          
          - **Commits**: $COMMITS_WEEK
          - **Contributors**: $CONTRIBUTORS_WEEK
          - **Date**: $(date +"%Y-%m-%d")
          
          ## Top Contributors
          $(git log --since='7 days ago' --format='%aN' | sort | uniq -c | sort -rn | head -5)
          
          ---
          *Generated automatically by GitHub Actions*
          EOF

      - name: Create issue with report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('weekly-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Weekly Report - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['report', 'automated']
            });