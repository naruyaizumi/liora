name: Issue Management

on:
  issues:
    types: [opened, labeled, reopened]
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  auto-label-issue:
    name: Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Label based on content
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body?.toLowerCase() || '';
            const labels = [];

            if (title.includes('bug') || title.includes('error')) labels.push('bug');
            if (title.includes('feature') || title.includes('enhancement')) labels.push('enhancement');
            if (title.includes('docs') || title.includes('documentation')) labels.push('documentation');
            if (title.includes('question') || title.includes('help')) labels.push('question');
            if (body.includes('whatsapp') || title.includes('whatsapp')) labels.push('whatsapp');
            if (title.includes('security') || title.includes('vulnerability')) {
              labels.push('security', 'priority-high');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

  greet-first-contributor:
    name: Greet First Time Contributors
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Check if first issue
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: creator,
              state: 'all'
            });
            
            if (issues.data.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ðŸ‘‹ Welcome @${creator}! Thank you for your first issue!\n\nA maintainer will review it soon. Please ensure you've provided:\n- Clear description\n- Steps to reproduce (if applicable)\n- Expected vs actual behavior\n- Environment details`
              });
            }

  validate-issue:
    name: Validate Issue Format
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Check issue format
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            if (body.length < 50) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This issue needs more detail.\n\nPlease provide:\n- Problem description\n- Steps to reproduce\n- Expected behavior\n- Environment details`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-more-info']
              });
            }

  close-stale:
    name: Close Stale Issues
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 1 * * *'
    steps:
      - name: Close stale issues
        uses: actions/stale@v10
        with:
          repo-token: ${{ secrets.PAT_TOKEN }}
          stale-issue-message: |
            This issue has been marked as stale due to inactivity.
            It will be closed in 7 days if no further activity occurs.
          close-issue-message: "Closed due to inactivity."
          days-before-stale: 30
          days-before-close: 7
          stale-issue-label: "stale"
          exempt-issue-labels: "pinned,security,priority-high"