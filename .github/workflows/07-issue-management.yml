name: Issue Management

on:
  issues:
    types: [opened, labeled, reopened]
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  auto-label-issue:
    name: Auto Label Issues
    runs-on: self-hosted
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Label based on content
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body?.toLowerCase() || '';
            const text = `${title} ${body}`;
            const labels = [];

            // Load labeler config
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            try {
              const config = yaml.load(fs.readFileSync('.github/issue-labeler.yml', 'utf8'));
              
              for (const [label, patterns] of Object.entries(config)) {
                for (const pattern of patterns) {
                  const regex = new RegExp(pattern, 'i');
                  if (regex.test(text)) {
                    labels.push(label);
                    break;
                  }
                }
              }
            } catch (e) {
              console.log('Using fallback labeling...');
              
              // Fallback labeling
              if (/bug|error|crash|fail/i.test(text)) labels.push('bug');
              if (/feature|enhancement|suggest/i.test(text)) labels.push('enhancement');
              if (/docs|documentation/i.test(text)) labels.push('documentation');
              if (/question|help|how/i.test(text)) labels.push('question');
              if (/whatsapp|baileys/i.test(text)) labels.push('whatsapp');
              if (/sticker|webp/i.test(text)) labels.push('sticker');
              if (/c\+\+|cpp|native/i.test(text)) labels.push('cpp');
              if (/security|vulnerability/i.test(text)) labels.push('security', 'priority-high');
              if (/performance|slow|optimize/i.test(text)) labels.push('performance');
            }

            // Remove duplicates
            const uniqueLabels = [...new Set(labels)];
            
            if (uniqueLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: uniqueLabels
              });
              
              console.log(`Applied labels: ${uniqueLabels.join(', ')}`);
            }

  greet-first-contributor:
    name: Greet First Time Contributors
    runs-on: self-hosted
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Check if first issue
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: creator,
              state: 'all'
            });
            
            if (issues.data.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ðŸ‘‹ Welcome @${creator}! Thank you for your first issue!\n\nA maintainer will review it soon. Please ensure you've provided:\n- Clear description\n- Steps to reproduce (if applicable)\n- Expected vs actual behavior\n- Environment details`
              });
            }

  validate-issue:
    name: Validate Issue Format
    runs-on: self-hosted
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Check issue format
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            if (body.length < 50) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This issue needs more detail.\n\nPlease provide:\n- Problem description\n- Steps to reproduce\n- Expected behavior\n- Environment details`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-more-info']
              });
            }

  close-stale:
    name: Close Stale Issues
    runs-on: self-hosted
    if: github.event.schedule == '0 1 * * *'
    steps:
      - name: Close stale issues
        uses: actions/stale@v10
        with:
          repo-token: ${{ secrets.PAT_TOKEN }}
          stale-issue-message: |
            This issue has been marked as stale due to inactivity.
            It will be closed in 7 days if no further activity occurs.
          close-issue-message: "Closed due to inactivity."
          days-before-stale: 30
          days-before-close: 7
          stale-issue-label: "stale"
          exempt-issue-labels: "pinned,security,priority-high"