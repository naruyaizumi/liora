name: Repository Mirror

on:
  push:
    branches: [main]
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  mirror-gitlab:
    name: Mirror to GitLab
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Mirror to GitLab
        run: |
          git config user.name "liora-bot"
          git config user.email "liora.bot.official@gmail.com"
          git remote add gitlab https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/naruyaizumi/liora.git 2>/dev/null || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Pushing main branch to GitLab..."
            git push gitlab main --force --tags
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            echo "Pushing tag ${{ github.ref_name }} to GitLab..."
            git push gitlab ${{ github.ref_name }}
          fi

  mirror-codeberg:
    name: Mirror to Codeberg
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Mirror to Codeberg
        run: |
          git config user.name "liora-bot"
          git config user.email "liora.bot.official@gmail.com"
          git remote add codeberg https://naruyaizumi:${{ secrets.CODEBERG_TOKEN }}@codeberg.org/naruyaizumi/liora.git 2>/dev/null || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Pushing main branch to Codeberg..."
            git push codeberg main --force --tags
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            echo "Pushing tag ${{ github.ref_name }} to Codeberg..."
            git push codeberg ${{ github.ref_name }}
          fi

  mirror-gitea:
    name: Mirror to Gitea
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Mirror to Gitea
        run: |
          git config user.name "liora-bot"
          git config user.email "liora.bot.official@gmail.com"
          git remote add gitea https://naruyaizumi:${{ secrets.GITEA_TOKEN }}@gitea.com/naruyaizumi/liora.git 2>/dev/null || true
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Pushing main branch to Gitea..."
            git push gitea main --force --tags
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            echo "Pushing tag ${{ github.ref_name }} to Gitea..."
            git push gitea ${{ github.ref_name }}
          fi

  mirror-summary:
    name: Mirror Summary
    needs: [mirror-gitlab, mirror-codeberg, mirror-gitea]
    runs-on: self-hosted
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Mirror Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitLab | ${{ needs.mirror-gitlab.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Codeberg | ${{ needs.mirror-codeberg.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitea | ${{ needs.mirror-gitea.result }} |" >> $GITHUB_STEP_SUMMARY