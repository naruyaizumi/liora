name: Repository Mirror

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  mirror-gitlab:
    name: Mirror to GitLab
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Mirror to GitLab
        run: |
          git config user.name "liora-bot"
          git config user.email "liora.bot.official@gmail.com"
          git remote add gitlab https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/naruyaizumi/liora.git 2>/dev/null || true
          git push gitlab main --force --tags

  mirror-codeberg:
    name: Mirror to Codeberg
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Mirror to Codeberg
        run: |
          git config user.name "liora-bot"
          git config user.email "liora.bot.official@gmail.com"
          git remote add codeberg https://naruyaizumi:${{ secrets.CODEBERG_TOKEN }}@codeberg.org/naruyaizumi/liora.git 2>/dev/null || true
          git push codeberg main --force --tags

  mirror-gitea:
    name: Mirror to Gitea
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Mirror to Gitea
        run: |
          git config user.name "liora-bot"
          git config user.email "liora.bot.official@gmail.com"
          git remote add gitea https://naruyaizumi:${{ secrets.GITEA_TOKEN }}@gitea.com/naruyaizumi/liora.git 2>/dev/null || true
          git push gitea main --force --tags

  mirror-summary:
    name: Mirror Summary
    needs: [mirror-gitlab, mirror-codeberg, mirror-gitea]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Mirror Status" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitLab | ${{ needs.mirror-gitlab.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Codeberg | ${{ needs.mirror-codeberg.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitea | ${{ needs.mirror-gitea.result }} |" >> $GITHUB_STEP_SUMMARY