name: Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  prettier:
    name: Prettier Format Check
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Check Prettier formatting
        id: prettier-check
        run: |
          if pnpm exec prettier --check "**/*.{js,mjs,cjs}" --config ./.github/prettier.config.js; then
            echo "needs_format=false" >> $GITHUB_OUTPUT
          else
            echo "needs_format=true" >> $GITHUB_OUTPUT
          fi

      - name: Auto-format if needed
        if: steps.prettier-check.outputs.needs_format == 'true'
        run: |
          pnpm exec prettier --write "**/*.{js,mjs,cjs}" --config ./.github/prettier.config.js

      - name: Commit formatting changes
        if: steps.prettier-check.outputs.needs_format == 'true' && github.event_name == 'pull_request'
        run: |
          git config user.name "liora-bot"
          git config user.email "liora.bot.official@gmail.com"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit -m "style: auto-format with prettier"
            git push
          fi

  eslint:
    name: ESLint Analysis
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Run ESLint
        run: pnpm exec eslint . --config ./.github/eslint.config.js

  validate-installer:
    name: Validate Installer Script
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check shellcheck availability
        id: check-shellcheck
        run: |
          command -v shellcheck && echo "available=true" >> $GITHUB_OUTPUT || echo "available=false" >> $GITHUB_OUTPUT

      - name: Lint installer script
        if: steps.check-shellcheck.outputs.available == 'true'
        run: shellcheck -e SC1091 -e SC2034 install.sh || true

      - name: Test installer (dry-run)
        run: |
          bash -n install.sh || exit 1