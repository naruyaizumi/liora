name: Prettier

on:
    push:
        branches: ["main"]

jobs:
    prettier:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.PAT_TOKEN }}
                  fetch-depth: 0

            - name: Check if package.json version changed
              id: version
              run: |
                  PREV_VERSION=$(git show HEAD^:package.json | jq -r '.version')
                  NEW_VERSION=$(jq -r '.version' package.json)
                  echo "Previous version: $PREV_VERSION"
                  echo "New version: $NEW_VERSION"
                  if [ "$PREV_VERSION" != "$NEW_VERSION" ]; then
                    echo "version_changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "version_changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false
              if: steps.version.outputs.version_changed == 'true'

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  check-latest: true
              if: steps.version.outputs.version_changed == 'true'

            - name: Install dependencies
              run: pnpm install --ignore-scripts
              if: steps.version.outputs.version_changed == 'true'

            - name: Run Prettier auto-format
              run: pnpm prettier --write . || true
              if: steps.version.outputs.version_changed == 'true'

            - name: Commit & Push changes
              run: |
                  git config --global user.name "naruyaizumi"
                  git config --global user.email "sexystyle088@gmail.com"
                  git add .
                  git diff --cached --quiet || git commit -m "style: auto-format with Prettier"
                  git push origin main || true
              if: steps.version.outputs.version_changed == 'true'
