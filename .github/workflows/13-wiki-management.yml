name: Wiki Management

on:
  push:
    branches: ["main"]
    paths:
      - "README.md"
      - "CHANGELOG.md"
      - "docs/**"
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-readme-to-wiki:
    name: Sync README to Wiki
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout wiki
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Sync README to Home page
        run: |
          cp README.md wiki/Home.md
          
          sed -i 's/](docs\//](/' wiki/Home.md
          sed -i 's/](\.\//](/' wiki/Home.md

      - name: Commit and push wiki changes
        working-directory: wiki
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --local user.name "naruyaizumi"
          git config --local user.email "sexystyle088@gmail.com"
          
          git remote set-url origin "https://naruyaizumi:$PAT_TOKEN@github.com/naruyaizumi/liora.wiki.git"
          
          if [[ `git status --porcelain` ]]; then
            git add Home.md
            git commit -m "docs: sync README to wiki [automated]"
            git push origin HEAD 2>&1 | sed "s/$PAT_TOKEN/***/g"
            echo "README synced to wiki"
          else
            echo "No changes to sync"
          fi

  update-changelog-archive:
    name: Archive Changelog to Wiki
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout wiki
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Create changelog archive structure
        run: |
          mkdir -p wiki/changelog-archive
          
          VERSION="${{ github.event.release.tag_name }}"
          VERSION_CLEAN="${VERSION#v}"
          DATE=$(date +%Y-%m-%d)
          
          awk "/## \[$VERSION_CLEAN\]/,/## \[/" CHANGELOG.md | head -n -1 > wiki/changelog-archive/v${VERSION_CLEAN}.md

          if [[ -s "wiki/changelog-archive/v${VERSION_CLEAN}.md" ]]; then
            echo "Changelog extracted for $VERSION"
          else
            echo "Warning: No changelog found for $VERSION"
            echo "No changelog available for $VERSION" > "wiki/changelog-archive/v${VERSION_CLEAN}.md"
          fi
          
          if [ ! -f wiki/Changelog-Archive.md ]; then
            cat > wiki/Changelog-Archive.md << 'EOF'
            
            # ðŸ“œ Changelog Archive
            
            Archive of all version changelogs for Liora WhatsApp Bot.
            
            ## Available Versions
            
            EOF
          fi
          
          if ! grep -q "Version $VERSION_CLEAN" wiki/Changelog-Archive.md; then
            sed -i "6a - [Version $VERSION_CLEAN](changelog-archive/v${VERSION_CLEAN}) - $DATE" wiki/Changelog-Archive.md
          fi

      - name: Commit changelog archive
        working-directory: wiki
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --local user.name "naruyaizumi"
          git config --local user.email "sexystyle088@gmail.com"
          
          git remote set-url origin "https://naruyaizumi:$PAT_TOKEN@github.com/naruyaizumi/liora.wiki.git"
          
          CHANGES=$(git status --porcelain)
          
          if [[ -n "$CHANGES" ]]; then
            echo "Changes detected:"
            echo "$CHANGES"
            
            git add changelog-archive/ Changelog-Archive.md
            git commit -m "docs: archive changelog for ${{ github.event.release.tag_name }} [automated]"
            git push origin HEAD 2>&1 | sed "s/$PAT_TOKEN/***/g"
            echo "Changelog archived"
          else
            echo "No changes to commit"
          fi

  update-bot-stats:
    name: Update Bot Statistics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout wiki
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Collect bot statistics
        id: stats
        run: |
          TOTAL_COMMITS=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          TOTAL_RELEASES=$(git tag | wc -l)
          LATEST_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          TOTAL_FILES=$(find src lib -type f \( -name "*.js" -o -name "*.rs" -o -name "*.cpp" \) 2>/dev/null | wc -l || echo "0")
          TOTAL_LINES=$(find src lib -type f \( -name "*.js" -o -name "*.rs" -o -name "*.cpp" \) -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          
          COMMITS_LAST_MONTH=$(git log --since='30 days ago' --oneline 2>/dev/null | wc -l || echo "0")
          LAST_COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M UTC' 2>/dev/null || echo "N/A")
          
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          echo "total_releases=$TOTAL_RELEASES" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
          echo "commits_last_month=$COMMITS_LAST_MONTH" >> $GITHUB_OUTPUT
          echo "last_commit_date=$LAST_COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: Generate bot stats page
        run: |
          cat > wiki/Bot-Statistics.md << EOF
          # ðŸ“Š Liora Bot Statistics
          
          *Last updated: $(date -u +"%Y-%m-%d %H:%M UTC")*
          
          ## ðŸ¤– Bot Information
          
          | Metric | Value |
          |--------|-------|
          | **Latest Version** | ${{ steps.stats.outputs.latest_version }} |
          | **Total Releases** | ${{ steps.stats.outputs.total_releases }} |
          | **License** | Apache-2.0 |
          | **Platform** | WhatsApp (Baileys) |
          
          ## ðŸ“ˆ Development Statistics
          
          | Metric | Value |
          |--------|-------|
          | **Total Commits** | ${{ steps.stats.outputs.total_commits }} |
          | **Contributors** | ${{ steps.stats.outputs.contributors }} |
          | **Total Files** | ${{ steps.stats.outputs.total_files }} |
          | **Lines of Code** | ${{ steps.stats.outputs.total_lines }} |
          | **Last Commit** | ${{ steps.stats.outputs.last_commit_date }} |
          
          ## ðŸ”¥ Recent Activity (Last 30 Days)
          
          - **Commits**: ${{ steps.stats.outputs.commits_last_month }}
          - **Status**: ðŸŸ¢ Active Development
          
          ## ðŸŒŸ Features
          
          - âœ… Multi-platform support (Ubuntu, Debian, RHEL, Arch)
          - âœ… Comprehensive API integrations
          - âœ… Production-ready CI/CD
          - âœ… Automatic security scanning
          - âœ… Real-time monitoring
          
          ## ðŸ“š Resources
          
          - [Documentation](https://naruyaizumi.github.io/liora)
          - [Changelog Archive](Changelog-Archive)
          - [Installation Guide](Installation)
          - [API Reference](API-Reference)
          
          ## ðŸ“Š Language Distribution
          
          \`\`\`
          JavaScript: $(find src lib -name "*.js" 2>/dev/null | wc -l || echo "0") files
          \`\`\`
          
          ## ðŸ† Top Contributors
          
          $(git log --format='%aN' | sort | uniq -c | sort -rn | head -10 2>/dev/null | awk '{print "- **" $2 " " $3 "**: " $1 " commits"}' || echo "- No contributor data available")
          
          ---
          
          *Statistics generated automatically by GitHub Actions*
          EOF

      - name: Commit bot stats
        working-directory: wiki
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --local user.name "naruyaizumi"
          git config --local user.email "sexystyle088@gmail.com"
          
          git remote set-url origin "https://naruyaizumi:$PAT_TOKEN@github.com/naruyaizumi/liora.wiki.git"
          
          if [[ -f "Bot-Statistics.md" ]] && [[ -n $(git status --porcelain Bot-Statistics.md 2>/dev/null) ]]; then
            git add Bot-Statistics.md
            git commit -m "docs: update bot statistics [automated]"
            git push origin HEAD 2>&1 | sed "s/$PAT_TOKEN/***/g"
            echo "Bot statistics updated"
          else
            echo "Bot statistics unchanged or file doesn't exist"
          fi

  create-installation-guide:
    name: Create Installation Guide
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v6

      - name: Checkout wiki
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Check if Installation.md exists or is outdated
        id: check_install
        run: |
          # Cek apakah file ada dan kapan terakhir di-update
          if [[ -f "wiki/Installation.md" ]]; then
            # Compare dengan template
            echo "Installation.md exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate installation guide
        if: steps.check_install.outputs.exists == 'false'
        run: |
          cat > wiki/Installation.md << 'EOF'
          # ðŸš€ Installation Guide
          
          Complete guide to install and run Liora WhatsApp Bot on various platforms.
          
          ## Quick Start
          
          ### One-Line Installation (Recommended)
          
          ```bash
          curl -fsSL https://raw.githubusercontent.com/naruyaizumi/liora/main/service.sh | bash
          ```
          
          This will automatically:
          - Detect your OS and install dependencies
          - Download and setup Liora
          - Configure systemd service (if available)
          - Start the bot
          
          ## Supported Operating Systems
          
          - âœ… Ubuntu 24.04 LTS (Noble)
          - âœ… Debian 12 (Bookworm)
          - âœ… Red Hat Enterprise Linux 9
          - âœ… Arch Linux (latest)
          - âœ… Other systemd-based distributions
          
          ## Manual Installation
          
          ### Prerequisites
          
          1. **System Dependencies**:
             ```bash
             # Ubuntu/Debian
             sudo apt-get update
             sudo apt-get install -y curl git ffmpeg build-essential python3 g++ cmake
             
             # RHEL/CentOS/Fedora
             sudo dnf install -y curl git ffmpeg gcc-c++ python3 cmake
             
             # Arch Linux
             sudo pacman -S curl git ffmpeg base-devel python cmake
             ```
          
          2. **Install Bun**:
             ```bash
             curl -fsSL https://bun.sh/install | bash
             source ~/.bashrc  # or ~/.zshrc
             ```
          
          ### Installation Steps
          
          1. **Clone Repository**:
             ```bash
             git clone https://github.com/naruyaizumi/liora.git
             cd liora
             ```
          
          2. **Install Dependencies**:
             ```bash
             bun install
             ```
          
          3. **Build Native Modules**:
             ```bash
             bun run build
             ```
          
          4. **Start Bot**:
             ```bash
             bun run src/index.js
             ```
          
          ## Running as Service
          
          ### systemd Service (Ubuntu/Debian/RHEL)
          
          1. Create service file:
             ```bash
             sudo nano /etc/systemd/system/liora.service
             ```
          
          2. Add configuration:
             ```ini
             [Unit]
             Description=Liora WhatsApp Bot
             After=network.target
             
             [Service]
             Type=simple
             User=liora
             WorkingDirectory=/opt/liora
             ExecStart=/root/.bun/bin/bun run src/index.js
             Restart=always
             RestartSec=10
             StandardOutput=journal
             StandardError=journal
             
             [Install]
             WantedBy=multi-user.target
             ```
          
          3. Enable and start:
             ```bash
             sudo systemctl daemon-reload
             sudo systemctl enable liora
             sudo systemctl start liora
             ```
          
          ### Check Status
          
          ```bash
          sudo systemctl status liora
          sudo journalctl -u liora -f
          ```
          
          ## Configuration
          
          Edit `src/config.js` to customize:
          - Bot prefix
          - Owner number
          - Feature toggles
          - API keys
          
          ## Troubleshooting
          
          ### Bot Not Starting
          
          1. Check logs:
             ```bash
             sudo journalctl -u liora -n 50
             ```
          
          2. Verify dependencies:
             ```bash
             bun --version
             node --version
             ```
          
          3. Check permissions:
             ```bash
             ls -la /opt/liora
             ```
          
          ### Connection Issues
          
          1. Check firewall:
             ```bash
             sudo ufw status
             ```
          
          2. Verify network:
             ```bash
             ping -c 4 github.com
             ```
          
          ## Updating
          
          ```bash
          cd /opt/liora
          git pull origin main
          bun install
          bun run build
          sudo systemctl restart liora
          ```
          
          ## Uninstallation
          
          ```bash
          sudo systemctl stop liora
          sudo systemctl disable liora
          sudo rm /etc/systemd/system/liora.service
          sudo rm -rf /opt/liora
          ```
          
          ---
          
          For more help, visit [GitHub Issues](https://github.com/naruyaizumi/liora/issues)
          EOF

      - name: Commit installation guide
        working-directory: wiki
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --local user.name "naruyaizumi"
          git config --local user.email "sexystyle088@gmail.com"

          git remote set-url origin "https://naruyaizumi:$PAT_TOKEN@github.com/naruyaizumi/liora.wiki.git"
          
          if [[ ! -f "Installation.md" ]] || [[ -n $(git status --porcelain Installation.md 2>/dev/null) ]]; then
            git add Installation.md
            git commit -m "docs: update installation guide [automated]"
            git push origin HEAD 2>&1 | sed "s/$PAT_TOKEN/***/g"
            echo "Installation guide updated"
          else
            echo "Installation guide unchanged"
          fi

  update-wiki-sidebar:
    name: Update Wiki Sidebar
    runs-on: ubuntu-latest
    needs: [sync-readme-to-wiki, update-bot-stats, create-installation-guide]
    steps:
      - name: Checkout wiki
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Check current sidebar content
        id: check_sidebar
        run: |
          DESIRED_SIDEBAR="# ðŸ“š Liora Wiki
          
          ## ðŸ  Home
          - [Home](Home)
          - [Bot Statistics](Bot-Statistics)
          
          ## ðŸš€ Getting Started
          - [Installation](Installation)
          - [Quick Start](Quick-Start)
          - [Configuration](Configuration)
          
          ## ðŸ“– Documentation
          - [API Reference](API-Reference)
          - [Command List](Commands)
          - [Features](Features)
          
          ## ðŸ“œ Changelog
          - [Latest Changes](../CHANGELOG.md)
          - [Changelog Archive](Changelog-Archive)
          
          ## ðŸ”§ Development
          - [Contributing](Contributing)
          - [Code of Conduct](Code-of-Conduct)
          - [Architecture](Architecture)
          
          ## ðŸ› Support
          - [Troubleshooting](Troubleshooting)
          - [FAQ](FAQ)
          - [GitHub Issues](https://github.com/naruyaizumi/liora/issues)
          
          ---"

          CURRENT_CONTENT=$(cat _Sidebar.md 2>/dev/null || echo "")
          DESIRED_NORMALIZED=$(echo "$DESIRED_SIDEBAR" | sed 's/\r$//')
          CURRENT_NORMALIZED=$(echo "$CURRENT_CONTENT" | sed 's/\r$//')
          
          if [[ "$DESIRED_NORMALIZED" == "$CURRENT_NORMALIZED" ]]; then
            echo "Sidebar content unchanged"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Sidebar needs update"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate sidebar
        if: steps.check_sidebar.outputs.changed == 'true'
        run: |
          cat > wiki/_Sidebar.md << 'EOF'
          # ðŸ“š Liora Wiki
          
          ## ðŸ  Home
          - [Home](Home)
          - [Bot Statistics](Bot-Statistics)
          
          ## ðŸš€ Getting Started
          - [Installation](Installation)
          - [Quick Start](Quick-Start)
          - [Configuration](Configuration)
          
          ## ðŸ“– Documentation
          - [API Reference](API-Reference)
          - [Command List](Commands)
          - [Features](Features)
          
          ## ðŸ“œ Changelog
          - [Latest Changes](../CHANGELOG.md)
          - [Changelog Archive](Changelog-Archive)
          
          ## ðŸ”§ Development
          - [Contributing](Contributing)
          - [Code of Conduct](Code-of-Conduct)
          - [Architecture](Architecture)
          
          ## ðŸ› Support
          - [Troubleshooting](Troubleshooting)
          - [FAQ](FAQ)
          - [GitHub Issues](https://github.com/naruyaizumi/liora/issues)
          
          ---
          EOF

      - name: Commit sidebar
        working-directory: wiki
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --local user.name "naruyaizumi"
          git config --local user.email "sexystyle088@gmail.com"
          
          git remote set-url origin "https://naruyaizumi:$PAT_TOKEN@github.com/naruyaizumi/liora.wiki.git"
          
          if [[ -f "_Sidebar.md" ]] && [[ -n $(git status --porcelain _Sidebar.md 2>/dev/null) ]]; then
            git add _Sidebar.md
            git commit -m "docs: update wiki sidebar [automated]"
            git push origin HEAD 2>&1 | sed "s/$PAT_TOKEN/***/g"
            echo "Wiki sidebar updated"
          else
            echo "No sidebar changes to commit"
          fi