name: Dependency Management

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-bun-deps:
    name: Update Bun Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check for outdated packages
        id: outdated
        run: |
          bun outdated --json > outdated.json || echo "[]" > outdated.json
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "[]" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Update dependencies
        if: steps.outdated.outputs.has_updates == 'true'
        run: |
          bun update --latest

      - name: Create Pull Request
        if: steps.outdated.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update bun dependencies"
          title: "chore(deps): update bun dependencies"
          body: |
            ## Dependency Updates
            
            This PR updates outdated Bun dependencies.
            
            ### Changes
            - Auto-generated by dependency update workflow
            - All dependencies have been updated to their latest versions
            
            Please review the changes and ensure all tests pass before merging.
          branch: deps/bun-update
          delete-branch: true
          labels: dependencies, automated

  update-rust-deps:
    name: Update Rust Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Update Rust dependencies
        working-directory: ./lib/rs
        run: |
          cargo update
          cargo upgrade --incompatible

      - name: Run tests
        working-directory: ./lib/rs
        run: cargo test

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update rust dependencies"
          title: "chore(deps): update rust dependencies"
          body: |
            ## Rust Dependency Updates
            
            This PR updates Rust dependencies in lib/rs.
            
            ### Changes
            - Updated Cargo.lock with latest compatible versions
            - All tests passing
            
            Please review before merging.
          branch: deps/rust-update
          delete-branch: true
          labels: dependencies, rust, automated

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run npm audit
        run: |
          npm audit --json > audit.json || true
          
          if [ -s audit.json ]; then
            HIGH_VULNS=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
            CRITICAL_VULNS=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)
            
            if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
              echo "::warning::Found $HIGH_VULNS high and $CRITICAL_VULNS critical vulnerabilities"
              npm audit fix || true
            fi
          fi

      - name: Rust security audit
        working-directory: ./lib/rs
        run: |
          cargo install cargo-audit
          cargo audit

      - name: Create security issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”’ Security Vulnerabilities Detected',
              body: 'Security vulnerabilities were found during the automated audit. Please check the workflow logs for details.',
              labels: ['security', 'priority-high']
            });