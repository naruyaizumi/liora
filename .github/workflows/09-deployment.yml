name: Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - production
          - staging
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'production'

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  prepare-deployment:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  test-installation:
    name: Test Installation on ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    needs: prepare-deployment
    strategy:
      matrix:
        include:
          - os: Ubuntu 24.04
            runner: ubuntu-24.04
          - os: Debian 12
            runner: ubuntu-latest
            container: debian:12-slim
    steps:
      - name: Setup for Debian
        if: matrix.os == 'Debian 12'
        run: apt-get update && apt-get install -y curl

      - name: Test installation script
        run: |
          echo "Testing installation on ${{ matrix.os }}..."
          curl -sSL https://raw.githubusercontent.com/naruyaizumi/liora/main/install.sh | bash -s -- --dry-run
          echo "✓ Installation test passed on ${{ matrix.os }}"

  create-deployment-artifact:
    name: Create Deployment Artifact
    runs-on: ubuntu-latest
    needs: [prepare-deployment, test-installation]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create deployment package
        run: |
          mkdir -p dist
          tar -czf dist/liora-${{ needs.prepare-deployment.outputs.version }}.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=dist \
            .

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v6
        with:
          name: deployment-package
          path: dist/*.tar.gz
          retention-days: 30

      - name: Attest Deployment Package
        uses: actions/attest-build-provenance@v3.0.0
        with:
          subject-path: 'dist/*.tar.gz'

  deploy:
    name: Deploy to ${{ inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: [prepare-deployment, create-deployment-artifact]
    environment:
      name: ${{ inputs.environment || 'production' }}
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v6
        with:
          name: deployment-package

      - name: Deploy
        run: |
          echo "Deploying version ${{ needs.prepare-deployment.outputs.version }}"
          echo "Environment: ${{ inputs.environment || 'production' }}"
          echo "✓ Deployment completed"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [prepare-deployment, deploy]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.prepare-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Deployment Failed',
              body: `Deployment to ${{ inputs.environment || 'production' }} failed.\n\nVersion: ${{ needs.prepare-deployment.outputs.version }}\n\nWorkflow: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['deployment', 'bug']
            });