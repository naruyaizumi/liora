name: Deployment

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  prepare-deployment:
    name: Prepare Deployment
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.environment.outputs.env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Determine environment
        id: environment
        run: |
          TAG="${{ github.ref_name }}"
          
          if [[ "$TAG" =~ v[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+ ]]; then
            echo "env=staging" >> $GITHUB_OUTPUT
          elif [[ "$TAG" =~ v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+ ]]; then
            echo "env=staging" >> $GITHUB_OUTPUT
          elif [[ "$TAG" =~ v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "env=staging" >> $GITHUB_OUTPUT
          fi

  test-installation:
    name: Test Installation
    runs-on: self-hosted
    needs: prepare-deployment
    steps:
      - name: Test installation script
        run: |
          echo "Testing installation on Ubuntu 24.04..."
          curl -sSL https://raw.githubusercontent.com/naruyaizumi/liora/main/install.sh | bash -s -- --dry-run
          echo "✓ Installation test passed"

  create-deployment-artifact:
    name: Create Deployment Artifact
    runs-on: self-hosted
    needs: [prepare-deployment, test-installation]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create deployment package
        run: |
          mkdir -p artifact
          tar -czf artifact/liora-${{ needs.prepare-deployment.outputs.version }}.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=artifact \
            .

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v6
        with:
          name: deployment-package-${{ needs.prepare-deployment.outputs.version }}
          path: artifact/*.tar.gz
          retention-days: 30

  deploy:
    name: Deploy to ${{ needs.prepare-deployment.outputs.environment || 'production' }}
    runs-on: self-hosted
    needs: [prepare-deployment, create-deployment-artifact]
    environment:
      name: ${{ needs.prepare-deployment.outputs.environment || 'production' }}
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v6
        with:
          name: deployment-package-${{ needs.prepare-deployment.outputs.version }}

      - name: Deploy
        run: |
          echo "Deploying version ${{ needs.prepare-deployment.outputs.version }}"
          echo "Environment: ${{ needs.prepare-deployment.outputs.environment || 'production' }}"
          echo "✓ Deployment completed"

  notify:
    name: Notify Deployment Status
    runs-on: self-hosted
    needs: [prepare-deployment, deploy]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.prepare-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.prepare-deployment.outputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Deployment Failed',
              body: `Deployment to ${{ needs.prepare-deployment.outputs.environment || 'production' }} failed.\n\nVersion: ${{ needs.prepare-deployment.outputs.version }}\n\nWorkflow: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['deployment', 'bug']
            });