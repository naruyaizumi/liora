name: Workflow Orchestrator - Enhanced

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write
  actions: write
  checks: write
  issues: write
  id-token: write
  attestations: write

jobs:
  analyze-changes:
    name: Analyze Changes
    runs-on: self-hosted
    outputs:
      needs_code_quality: ${{ steps.analyze.outputs.needs_code_quality }}
      needs_security: ${{ steps.analyze.outputs.needs_security }}
      needs_build: ${{ steps.analyze.outputs.needs_build }}
      version_changed: ${{ steps.analyze.outputs.version_changed }}
      has_cpp_changes: ${{ steps.analyze.outputs.has_cpp_changes }}
      has_js_changes: ${{ steps.analyze.outputs.has_js_changes }}
      new_version: ${{ steps.analyze.outputs.new_version }}
      force_trigger: ${{ steps.analyze.outputs.force_trigger }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Analyze changes
        id: analyze
        run: |
          echo "=== Starting Change Analysis ==="
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            echo "PR Mode: Comparing $BASE_SHA..$HEAD_SHA"
          else
            if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
              BASE_SHA="HEAD~1"
            else
              BASE_SHA="${{ github.event.before }}"
            fi
            HEAD_SHA="${{ github.sha }}"
            echo "Push Mode: Comparing $BASE_SHA..$HEAD_SHA"
          fi
          
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || echo "")
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "---"
          
          FORCE_TRIGGER=false
          
          if echo "$CHANGED_FILES" | grep -qE '\.(js|cpp|h|cc)$'; then
            echo "needs_code_quality=true" >> $GITHUB_OUTPUT
            echo "âœ“ Code quality check needed"
          else
            echo "needs_code_quality=false" >> $GITHUB_OUTPUT
            echo "âœ— No code quality check needed"
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.(cpp|h|cc)$'; then
            echo "has_cpp_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Has C++ changes"
          else
            echo "has_cpp_changes=false" >> $GITHUB_OUTPUT
            echo "âœ— No C++ changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.js$'; then
            echo "has_js_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Has JS changes"
          else
            echo "has_js_changes=false" >> $GITHUB_OUTPUT
            echo "âœ— No JS changes"
          fi
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "needs_security=true" >> $GITHUB_OUTPUT
            echo "âœ“ Security scan needed"
          else
            echo "needs_security=false" >> $GITHUB_OUTPUT
            echo "âœ— Security scan not needed"
          fi
          
          echo "=== Checking Version Change ==="
          VERSION_CHANGED=false
          NEW_VERSION=""
          
          if echo "$CHANGED_FILES" | grep -q "package.json"; then
            echo "âœ“ package.json changed"
            PREV_VERSION=$(git show $BASE_SHA:package.json 2>/dev/null | jq -r '.version' || echo "0.0.0")
            CURRENT_VERSION=$(jq -r '.version' package.json)
            
            echo "Previous: $PREV_VERSION"
            echo "Current: $CURRENT_VERSION"
            
            if [[ "$PREV_VERSION" != "$CURRENT_VERSION" ]]; then
              VERSION_CHANGED=true
              NEW_VERSION="$CURRENT_VERSION"
              FORCE_TRIGGER=true
              echo "âœ“ VERSION CHANGED: $PREV_VERSION â†’ $CURRENT_VERSION"
              echo "ðŸš€ FORCE TRIGGER ENABLED for build jobs"
            fi
          fi
          
          if [[ "$FORCE_TRIGGER" == "true" ]] || echo "$CHANGED_FILES" | grep -qE '\.(cpp|h|cc|gyp|json|js|py|ts)$'; then
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "âœ“ Build needed (force trigger or relevant changes)"
          else
            echo "needs_build=false" >> $GITHUB_OUTPUT
            echo "âœ— Build not needed"
          fi
          
          if [[ "$VERSION_CHANGED" == "true" && "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "force_trigger=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ WILL TRIGGER RELEASE for v$NEW_VERSION"
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "new_version=" >> $GITHUB_OUTPUT
            echo "force_trigger=false" >> $GITHUB_OUTPUT
          fi
          
          echo "=== Analysis Complete ==="

  code-quality:
    name: Code Quality Check
    needs: analyze-changes
    if: |
      needs.analyze-changes.outputs.needs_code_quality == 'true' ||
      needs.analyze-changes.outputs.version_changed == 'true'
    uses: ./.github/workflows/01-code-quality.yml
    secrets: inherit

  cpp-quality:
    name: C++ Code Quality
    needs: analyze-changes
    if: |
      needs.analyze-changes.outputs.has_cpp_changes == 'true' ||
      needs.analyze-changes.outputs.version_changed == 'true'
    uses: ./.github/workflows/01b-cpp-quality.yml
    secrets: inherit

  security-scan:
    name: Security Scanning
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_security == 'true'
    uses: ./.github/workflows/02-security-scan.yml
    secrets: inherit
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write

  build-test:
    name: Build & Test
    needs: [analyze-changes, code-quality, cpp-quality]
    if: |
      needs.analyze-changes.outputs.needs_build == 'true' ||
      needs.analyze-changes.outputs.version_changed == 'true'
    uses: ./.github/workflows/03-build-test.yml
    secrets: inherit
    permissions:
      contents: read
      checks: write
      attestations: write
      id-token: write

  release:
    name: Release Management
    needs: [analyze-changes, build-test, security-scan]
    if: |
      (needs.analyze-changes.outputs.version_changed == 'true' && needs.build-test.result != 'failure') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    uses: ./.github/workflows/04-release.yml
    secrets: inherit

  summary:
    name: Orchestrator Summary
    needs: [analyze-changes, code-quality, cpp-quality, security-scan, build-test, release]
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate summary
        run: |
          echo "# Enhanced Workflow Orchestrator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger Type**: ${{ github.event.inputs.trigger_type || 'automatic' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality Needed | ${{ needs.analyze-changes.outputs.needs_code_quality }} |" >> $GITHUB_STEP_SUMMARY
          echo "| C++ Changes | ${{ needs.analyze-changes.outputs.has_cpp_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan Needed | ${{ needs.analyze-changes.outputs.needs_security }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Needed | ${{ needs.analyze-changes.outputs.needs_build }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Changed** | **${{ needs.analyze-changes.outputs.version_changed }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| **New Version** | **${{ needs.analyze-changes.outputs.new_version || 'N/A' }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Force Trigger** | **${{ needs.analyze-changes.outputs.force_trigger }}** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "##Executed Workflows" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status | Trigger Reason |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.code-quality.result }}" == "skipped" ]]; then
            echo "| Code Quality | ${{ needs.code-quality.result }} | No code changes or version update |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Quality | ${{ needs.code-quality.result }} | Code changes detected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.cpp-quality.result }}" == "skipped" ]]; then
            echo "| C++ Quality | ${{ needs.cpp-quality.result }} | No C++ changes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| C++ Quality | ${{ needs.cpp-quality.result }} | C++ changes detected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.security-scan.result }}" == "skipped" ]]; then
            echo "| Security Scan | ${{ needs.security-scan.result }} | Not a main branch push |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security Scan | ${{ needs.security-scan.result }} | Main branch security scan |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.build-test.result }}" == "skipped" ]]; then
            echo "| Build & Test | ${{ needs.build-test.result }} | No build needed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build & Test | ${{ needs.build-test.result }} | Build triggered |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.release.result }}" == "skipped" ]]; then
            echo "| **Release** | **${{ needs.release.result }}** | Version unchanged or build failed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.release.result }}" == "success" ]]; then
            echo "| **Release** | **${{ needs.release.result }}** | ðŸš€ Version ${{ needs.analyze-changes.outputs.new_version }} released |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Release** | **${{ needs.release.result }}** | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "##Flow Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.analyze-changes.outputs.version_changed }}" == "true" ]]; then
            echo "### Version Update Detected!" >> $GITHUB_STEP_SUMMARY
            echo "- **New Version**: ${{ needs.analyze-changes.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Force Trigger**: Enabled" >> $GITHUB_STEP_SUMMARY
            echo "- **All quality checks**: Executed regardless of file changes" >> $GITHUB_STEP_SUMMARY
            echo "- **Build & Test**: Always executed for version updates" >> $GITHUB_STEP_SUMMARY
            echo "- **Release**: Triggered if build succeeds" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Standard Change Detection" >> $GITHUB_STEP_SUMMARY
            echo "- **Selective execution** based on changed file types" >> $GITHUB_STEP_SUMMARY
            echo "- **Optimized resource usage**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Enhanced orchestrator - Minimal skips, maximum coverage*" >> $GITHUB_STEP_SUMMARY