name: Workflow Orchestrator

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write
  actions: write
  checks: write
  issues: write

jobs:
  analyze-changes:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      needs_code_quality: ${{ steps.analyze.outputs.needs_code_quality }}
      needs_security: ${{ steps.analyze.outputs.needs_security }}
      needs_build: ${{ steps.analyze.outputs.needs_build }}
      version_changed: ${{ steps.analyze.outputs.version_changed }}
      has_cpp_changes: ${{ steps.analyze.outputs.has_cpp_changes }}
      has_js_changes: ${{ steps.analyze.outputs.has_js_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Analyze changes
        id: analyze
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} 2>/dev/null || echo "")
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -qE '\.(js|cpp|h|cc)$'; then
            echo "needs_code_quality=true" >> $GITHUB_OUTPUT
            echo "✓ Code quality check needed"
          else
            echo "needs_code_quality=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.(cpp|h|cc)$'; then
            echo "has_cpp_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_cpp_changes=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.js$'; then
            echo "has_js_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_js_changes=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "needs_security=true" >> $GITHUB_OUTPUT
            echo "✓ Security scan needed (main push)"
          else
            echo "needs_security=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.(cpp|h|cc|gyp|json)$'; then
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "✓ Build needed"
          else
            echo "needs_build=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && echo "$CHANGED_FILES" | grep -q "package.json"; then
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              PREV_VERSION=$(git show ${{ github.event.pull_request.base.sha }}:package.json 2>/dev/null | jq -r '.version' || echo "0.0.0")
            else
              PREV_VERSION=$(git show ${{ github.event.before }}:package.json 2>/dev/null | jq -r '.version' || echo "0.0.0")
            fi
            NEW_VERSION=$(jq -r '.version' package.json)
            
            if [[ "$PREV_VERSION" != "$NEW_VERSION" ]]; then
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "✓ Version changed: $PREV_VERSION → $NEW_VERSION"
            else
              echo "version_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

  trigger-code-quality:
    name: Trigger Code Quality
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_code_quality == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger JS code quality workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log('Triggering code quality workflow...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '01-code-quality.yml',
              ref: context.ref.replace('refs/heads/', '')
            });
            console.log('✓ Code quality workflow triggered');

      - name: Trigger C++ code quality workflow
        if: needs.analyze-changes.outputs.has_cpp_changes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log('Triggering C++ quality workflow...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '01b-cpp-quality.yml',
              ref: context.ref.replace('refs/heads/', '')
            });
            console.log('✓ C++ quality workflow triggered');

  trigger-security:
    name: Trigger Security Scan
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_security == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger security workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log('Triggering security scan workflow...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '02-security-scan.yml',
              ref: 'main'
            });
            console.log('✓ Security scan workflow triggered');

  trigger-build:
    name: Trigger Build & Test
    needs: [analyze-changes, trigger-code-quality]
    if: |
      needs.analyze-changes.outputs.needs_build == 'true' &&
      (needs.trigger-code-quality.result == 'success' || needs.trigger-code-quality.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger build workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log('Triggering build & test workflow...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '03-build-test.yml',
              ref: context.ref.replace('refs/heads/', '')
            });
            console.log('✓ Build & test workflow triggered');

  trigger-release:
    name: Trigger Release
    needs: [analyze-changes, trigger-build]
    if: |
      needs.analyze-changes.outputs.version_changed == 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger release workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log('Triggering release workflow...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '04-release.yml',
              ref: 'main'
            });
            console.log('✓ Release workflow triggered');

  summary:
    name: Orchestrator Summary
    needs: [analyze-changes, trigger-code-quality, trigger-security, trigger-build, trigger-release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# Workflow Orchestrator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality Needed | ${{ needs.analyze-changes.outputs.needs_code_quality }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan Needed | ${{ needs.analyze-changes.outputs.needs_security }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Needed | ${{ needs.analyze-changes.outputs.needs_build }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Changed | ${{ needs.analyze-changes.outputs.version_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Triggered Workflows" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.trigger-code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.trigger-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.trigger-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.trigger-release.result }} |" >> $GITHUB_STEP_SUMMARY