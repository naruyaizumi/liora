name: Workflow Orchestrator

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write
  actions: write
  checks: write
  issues: write

jobs:
  analyze-changes:
    name: Analyze Changes
    runs-on: self-hosted
    outputs:
      needs_code_quality: ${{ steps.analyze.outputs.needs_code_quality }}
      needs_security: ${{ steps.analyze.outputs.needs_security }}
      needs_build: ${{ steps.analyze.outputs.needs_build }}
      version_changed: ${{ steps.analyze.outputs.version_changed }}
      has_cpp_changes: ${{ steps.analyze.outputs.has_cpp_changes }}
      has_js_changes: ${{ steps.analyze.outputs.has_js_changes }}
      new_version: ${{ steps.analyze.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Analyze changes
        id: analyze
        run: |
          echo "=== Starting Change Analysis ==="
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            echo "PR Mode: Comparing $BASE_SHA..$HEAD_SHA"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
              BASE_SHA="HEAD~1"
            else
              BASE_SHA="${{ github.event.before }}"
            fi
            HEAD_SHA="${{ github.sha }}"
            echo "Push Mode: Comparing $BASE_SHA..$HEAD_SHA"
          else
            BASE_SHA="HEAD~1"
            HEAD_SHA="HEAD"
            echo "Manual Mode: Comparing last commit"
          fi
          
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "---"
          
          if echo "$CHANGED_FILES" | grep -qE '\.(js|cpp|h|cc)$'; then
            echo "needs_code_quality=true" >> $GITHUB_OUTPUT
            echo "âœ“ Code quality check needed"
          else
            echo "needs_code_quality=false" >> $GITHUB_OUTPUT
            echo "âœ— No code quality check needed"
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.(cpp|h|cc)$'; then
            echo "has_cpp_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Has C++ changes"
          else
            echo "has_cpp_changes=false" >> $GITHUB_OUTPUT
            echo "âœ— No C++ changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.js$'; then
            echo "has_js_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Has JS changes"
          else
            echo "has_js_changes=false" >> $GITHUB_OUTPUT
            echo "âœ— No JS changes"
          fi
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "needs_security=true" >> $GITHUB_OUTPUT
            echo "âœ“ Security scan needed (main push)"
          else
            echo "needs_security=false" >> $GITHUB_OUTPUT
            echo "âœ— Security scan not needed"
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '\.(cpp|h|cc|gyp|json)$'; then
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "âœ“ Build needed"
          else
            echo "needs_build=false" >> $GITHUB_OUTPUT
            echo "âœ— Build not needed"
          fi
          
          echo "=== Checking Version Change ==="
          VERSION_CHANGED=false
          NEW_VERSION=""
          
          if echo "$CHANGED_FILES" | grep -q "package.json"; then
            echo "âœ“ package.json changed, checking version..."
            
            PREV_VERSION=$(git show $BASE_SHA:package.json 2>/dev/null | jq -r '.version' 2>/dev/null || echo "0.0.0")
            CURRENT_VERSION=$(jq -r '.version' package.json 2>/dev/null || echo "0.0.0")
            
            echo "Previous version: $PREV_VERSION"
            echo "Current version: $CURRENT_VERSION"
            
            if [[ "$PREV_VERSION" != "$CURRENT_VERSION" ]]; then
              VERSION_CHANGED=true
              NEW_VERSION="$CURRENT_VERSION"
              echo "âœ“ VERSION CHANGED: $PREV_VERSION â†’ $CURRENT_VERSION"
            else
              echo "âœ— Version unchanged: $CURRENT_VERSION"
            fi
          else
            echo "âœ— package.json not changed"
          fi
          
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" && "$VERSION_CHANGED" == "true" ]]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "ðŸš€ WILL TRIGGER RELEASE for v$NEW_VERSION"
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "new_version=" >> $GITHUB_OUTPUT
            echo "âœ— Release not triggered"
          fi
          
          echo "=== Analysis Complete ==="

  trigger-code-quality:
    name: Trigger Code Quality
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_code_quality == 'true'
    runs-on: self-hosted
    steps:
      - name: Trigger JS code quality workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '01-code-quality.yml',
              ref: context.ref.replace('refs/heads/', '').replace('refs/pull/', '')
            });

      - name: Trigger C++ code quality workflow
        if: needs.analyze-changes.outputs.has_cpp_changes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '01b-cpp-quality.yml',
              ref: context.ref.replace('refs/heads/', '').replace('refs/pull/', '')
            });

  trigger-security:
    name: Trigger Security Scan
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_security == 'true'
    runs-on: self-hosted
    steps:
      - name: Trigger security workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '02-security-scan.yml',
              ref: 'main'
            });

  trigger-build:
    name: Trigger Build & Test
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_build == 'true'
    runs-on: self-hosted
    steps:
      - name: Trigger build workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '03-build-test.yml',
              ref: context.ref.replace('refs/heads/', '').replace('refs/pull/', '')
            });

  trigger-release:
    name: Trigger Release
    needs: analyze-changes
    if: |
      needs.analyze-changes.outputs.version_changed == 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    runs-on: self-hosted
    steps:
      - name: Trigger release workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '04-release.yml',
              ref: 'main'
            });

  summary:
    name: Orchestrator Summary
    needs:
      - analyze-changes
      - trigger-code-quality
      - trigger-security
      - trigger-build
      - trigger-release
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate summary
        run: |
          echo "Workflow summary generated."