name: Workflow Orchestrator

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write
  actions: write
  checks: write
  issues: write

jobs:
  analyze-changes:
    name: Analyze Changes
    runs-on: self-hosted
    outputs:
      needs_code_quality: ${{ steps.analyze.outputs.needs_code_quality }}
      needs_security: ${{ steps.analyze.outputs.needs_security }}
      needs_build: ${{ steps.analyze.outputs.needs_build }}
      version_changed: ${{ steps.analyze.outputs.version_changed }}
      has_cpp_changes: ${{ steps.analyze.outputs.has_cpp_changes }}
      has_js_changes: ${{ steps.analyze.outputs.has_js_changes }}
      new_version: ${{ steps.analyze.outputs.new_version }}
      dispatch_ref: ${{ steps.analyze.outputs.dispatch_ref }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Analyze changes
        id: analyze
        shell: bash
        run: |
          echo "=== Starting Change Analysis ==="

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            DISPATCH_REF="${{ github.event.pull_request.head.ref }}"
            echo "PR Mode"
          else
            BASE_SHA="${{ github.event.before || 'HEAD~1' }}"
            HEAD_SHA="${{ github.sha }}"
            DISPATCH_REF="${{ github.ref_name }}"
            echo "Push / Manual Mode"
          fi

          echo "dispatch_ref=$DISPATCH_REF" >> $GITHUB_OUTPUT

          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" || true)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          echo "needs_code_quality=$(echo "$CHANGED_FILES" | grep -qE '\.(js|cpp|h|cc|json|sh|md|gyp)$' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_cpp_changes=$(echo "$CHANGED_FILES" | grep -qE '\.(cpp|h|cc)$' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_js_changes=$(echo "$CHANGED_FILES" | grep -qE '\.js$' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "needs_build=$(echo "$CHANGED_FILES" | grep -qE '\.(js|cpp|h|cc|json|sh|md|gyp)$' && echo true || echo false)" >> $GITHUB_OUTPUT

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "needs_security=true" >> $GITHUB_OUTPUT
          else
            echo "needs_security=false" >> $GITHUB_OUTPUT
          fi

          VERSION_CHANGED=false
          NEW_VERSION=""

          if echo "$CHANGED_FILES" | grep -q "package.json"; then
            PREV_VERSION=$(git show "$BASE_SHA:package.json" | jq -r '.version' || echo "0.0.0")
            CURRENT_VERSION=$(jq -r '.version' package.json)

            if [[ "$PREV_VERSION" != "$CURRENT_VERSION" ]]; then
              VERSION_CHANGED=true
              NEW_VERSION="$CURRENT_VERSION"
            fi
          fi

          if [[ "$VERSION_CHANGED" == "true" && "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "new_version=" >> $GITHUB_OUTPUT
          fi

          echo "=== Analysis Complete ==="

  trigger-code-quality:
    name: Trigger Code Quality
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_code_quality == 'true'
    runs-on: self-hosted
    steps:
      - name: Trigger JS Code Quality
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '01-code-quality.yml',
              ref: '${{ needs.analyze-changes.outputs.dispatch_ref }}'
            });

      - name: Trigger C++ Code Quality
        if: needs.analyze-changes.outputs.has_cpp_changes == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '01b-cpp-quality.yml',
              ref: '${{ needs.analyze-changes.outputs.dispatch_ref }}'
            });

  trigger-security:
    name: Trigger Security Scan
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_security == 'true'
    runs-on: self-hosted
    steps:
      - name: Trigger Security Workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '02-security-scan.yml',
              ref: 'main'
            });

  trigger-build:
    name: Trigger Build & Test
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_build == 'true'
    runs-on: self-hosted
    steps:
      - name: Trigger Build Workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '03-build-test.yml',
              ref: '${{ needs.analyze-changes.outputs.dispatch_ref }}'
            });

  trigger-release:
    name: Trigger Release
    needs: analyze-changes
    if: needs.analyze-changes.outputs.version_changed == 'true'
    runs-on: self-hosted
    steps:
      - name: Trigger Release Workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '04-release.yml',
              ref: 'main'
            });

  summary:
    name: Orchestrator Summary
    if: always()
    needs:
      - analyze-changes
      - trigger-code-quality
      - trigger-security
      - trigger-build
      - trigger-release
    runs-on: self-hosted
    steps:
      - run: echo "Workflow Orchestrator completed."