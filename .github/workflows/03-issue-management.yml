name: Issue Management

on:
    issues:
        types: [opened, edited, reopened, labeled]
    schedule:
        - cron: "0 1 * * *"

permissions:
    issues: write
    pull-requests: write

jobs:
    auto-label:
        name: Auto Label Issues
        runs-on: ubuntu-latest
        if: |
            github.event_name == 'issues' && 
            (github.event.action == 'opened' || github.event.action == 'edited')
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Auto label based on content
              uses: actions/github-script@v8
              with:
                  script: |
                      const issue = context.payload.issue;
                      const title = issue.title.toLowerCase();
                      const body = (issue.body || '').toLowerCase();
                      const text = `${title} ${body}`;
                      const labels = [];

                      // Priority labels
                      if (/\b(critical|urgent|blocker|severe)\b/.test(text)) labels.push('priority-high');
                      if (/\b(security|vulnerability|exploit|cve)\b/.test(text)) labels.push('priority-high', 'security');
                      if (/\b(data loss|corruption)\b/.test(text)) labels.push('priority-high');
                      if (/\b(important|significant)\b/.test(text)) labels.push('priority-medium');
                      if (/\b(nice to have|minor)\b/.test(text)) labels.push('priority-low');

                      // Type labels
                      if (/\b(bug|error|crash|exception|fail|broken|not working)\b/.test(text)) labels.push('bug');
                      if (/\b(feature|enhance|improvement|suggest|add support)\b/.test(text)) labels.push('enhancement');
                      if (/\b(docs|documentation|readme|wiki|guide|tutorial|typo|grammar)\b/.test(text)) labels.push('documentation');
                      if (/\b(how to|how do I|question|help|support|what is|why|when|where)\b/.test(text)) labels.push('question');

                      // Technology labels
                      if (/\b(baileys|whatsapp|connection|qr|pairing|message|chat|group)\b/.test(text)) labels.push('whatsapp');
                      if (/\b(sticker|webp)\b/.test(text)) labels.push('sticker');
                      if (/\b(video|audio|image|ffmpeg|conversion|mp4|mp3)\b/.test(text)) labels.push('media-processing');
                      if (/\b(api|endpoint|integration|tiktok|instagram|twitter|spotify|youtube)\b/.test(text)) labels.push('api');
                      if (/\b(slow|performance|speed|optimize|latency|memory|cpu)\b/.test(text)) labels.push('performance');
                      if (/\b(sqlite|database|session|auth|sql|query)\b/.test(text)) labels.push('database');
                      if (/\b(install|setup|configure|deployment|dependencies)\b/.test(text)) labels.push('installation');
                      if (/\b(test|testing|unit test)\b/.test(text)) labels.push('testing');
                      if (/\b(github actions|workflow|ci|cd|pipeline)\b/.test(text)) labels.push('ci-cd');

                      // OS labels
                      if (/\bubuntu\b/.test(text)) labels.push('ubuntu');
                      if (/\bdebian\b/.test(text)) labels.push('debian');

                      // Good first issue
                      if (/\b(beginner|easy|good first issue|starter)\b/.test(text)) labels.push('good-first-issue');

                      const uniqueLabels = [...new Set(labels)];

                      if (uniqueLabels.length > 0) {
                        await github.rest.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          labels: uniqueLabels
                        });
                        
                        console.log(`‚úÖ Applied labels: ${uniqueLabels.join(', ')}`);
                      }

    validate-issue:
        name: Validate Issue Format
        runs-on: ubuntu-latest
        if: github.event_name == 'issues' && github.event.action == 'opened'
        steps:
            - name: Check issue format
              uses: actions/github-script@v8
              with:
                  script: |
                      const issue = context.payload.issue;
                      const body = issue.body || '';
                      const title = issue.title || '';

                      const issues = [];

                      // Check title
                      if (title.length < 10) {
                        issues.push('- Title is too short (minimum 10 characters)');
                      }

                      // Check body
                      if (body.length < 50) {
                        issues.push('- Description is too short (minimum 50 characters)');
                      }

                      // Check for key sections in bug reports
                      const isBug = /\b(bug|error|crash|fail)\b/i.test(title + body);
                      if (isBug) {
                        if (!/steps to reproduce/i.test(body)) {
                          issues.push('- Missing "Steps to Reproduce" section');
                        }
                        if (!/expected/i.test(body)) {
                          issues.push('- Missing "Expected Behavior" section');
                        }
                        if (!/actual|current/i.test(body)) {
                          issues.push('- Missing "Actual Behavior" section');
                        }
                      }

                      if (issues.length > 0) {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          body: `## ‚ö†Ô∏è Issue Needs More Information

                      Thank you for opening this issue! However, it needs more detail to be actionable:

                      ${issues.join('\n')}

                      ### Please provide:

                      **For Bug Reports:**
                      - Clear description of the problem
                      - Steps to reproduce the issue
                      - Expected behavior
                      - Actual behavior
                      - Environment details (OS, Bun version, etc.)
                      - Error messages or logs (if any)

                      **For Feature Requests:**
                      - Clear description of the feature
                      - Use case and benefits
                      - Possible implementation approach (optional)

                      **For Questions:**
                      - What you're trying to achieve
                      - What you've already tried
                      - Specific questions

                      This helps us understand and address your issue faster! üöÄ`
                        });
                        
                        await github.rest.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          labels: ['needs-more-info']
                        });
                      }

    greet-first-issue:
        name: Greet First-Time Contributors
        runs-on: ubuntu-latest
        if: github.event_name == 'issues' && github.event.action == 'opened'
        steps:
            - name: Check if first issue
              uses: actions/github-script@v8
              with:
                  script: |
                      const issue = context.payload.issue;
                      const author = issue.user.login;

                      // Get all issues by this author
                      const { data: issues } = await github.rest.issues.listForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        creator: author,
                        state: 'all'
                      });

                      // If this is their first issue
                      if (issues.length === 1) {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          body: `## üëã Welcome @${author}!

                      Thank you for opening your first issue in this repository! We appreciate your contribution to making Liora better.

                      Here's what happens next:
                      - A maintainer will review your issue
                      - If more information is needed, we'll ask for it
                      - Once triaged, appropriate labels will be added

                      ### üìö Helpful Resources
                      - [Contributing Guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
                      - [Code of Conduct](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CODE_OF_CONDUCT.md)
                      - [Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}#readme)

                      We'll get back to you as soon as possible! üöÄ`
                        });
                      }

    close-stale:
        name: Close Stale Issues
        runs-on: ubuntu-latest
        if: github.event_name == 'schedule'
        steps:
            - name: Close stale issues
              uses: actions/stale@v10
              with:
                  repo-token: ${{ secrets.PAT_TOKEN }}
                  stale-issue-message: |
                      ## üìÖ This issue has been marked as stale

                      This issue has been automatically marked as stale because it has not had any activity for 30 days.

                      **It will be closed in 7 days** if no further activity occurs.

                      If this issue is still relevant, please:
                      - Comment on this issue to keep it open
                      - Provide additional information if requested
                      - Let us know if you're still experiencing this problem

                      Thank you for your contributions! üôè
                  close-issue-message: |
                      ## üîí This issue has been closed due to inactivity

                      This issue was automatically closed because it has been inactive for 37 days (30 days stale + 7 days grace period).

                      **Don't worry!** If this issue is still relevant:
                      - You can reopen it by commenting
                      - You can create a new issue with updated information
                      - You're always welcome to continue the discussion

                      Thank you for your understanding! üôè
                  days-before-stale: 30
                  days-before-close: 7
                  stale-issue-label: "stale"
                  exempt-issue-labels: "pinned,security,priority-high,in-progress"
                  exempt-all-milestones: true
                  operations-per-run: 100